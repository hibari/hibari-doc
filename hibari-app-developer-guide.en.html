<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Hibari Application Developer’s Guide DRAFT - IN PROGRESS</title><link rel="stylesheet" href="docbook-xsl.css" type="text/css" /><meta name="generator" content="DocBook XSL Stylesheets V1.75.2" /></head><body><div xml:lang="en" class="article" title="Hibari Application Developer&#x2019;s Guide DRAFT - IN PROGRESS" lang="en"><div class="titlepage"><div><div><h2 class="title"><a id="id36104938"></a>Hibari Application Developer’s Guide <span class="strong"><strong>DRAFT - IN PROGRESS</strong></span></h2></div><div><div class="revhistory"><table border="1" width="100%" summary="Revision history"><tr><th align="left" valign="top" colspan="2"><b>Revision History</b></th></tr><tr><td align="left">Revision 0.1.6</td><td align="left">2011/01/30</td></tr></table></div></div></div><hr /></div><div class="toc"><p><b>Table of Contents</b></p><dl><dt><span class="section"><a href="#_introduction">1. Introduction</a></span></dt><dd><dl><dt><span class="section"><a href="#_why_nosql">1.1. Why NoSQL?</a></span></dt><dt><span class="section"><a href="#_why_hibari">1.2. Why Hibari?</a></span></dt><dt><span class="section"><a href="#_how_hibari_works">1.3. How Hibari Works</a></span></dt></dl></dd><dt><span class="section"><a href="#_getting_started">2. Getting Started</a></span></dt><dd><dl><dt><span class="section"><a href="#_requirements">2.1. Requirements</a></span></dt><dt><span class="section"><a href="#_downloading_hibari">2.2. Downloading Hibari</a></span></dt><dt><span class="section"><a href="#_installing_hibari">2.3. Installing Hibari</a></span></dt><dt><span class="section"><a href="#_deploying_a_simple_hibari_system">2.4. Deploying a Simple Hibari System</a></span></dt></dl></dd><dt><span class="section"><a href="#client-api-erlang">3. Client API: Native Erlang</a></span></dt><dd><dl><dt><span class="section"><a href="#_overview">3.1. Overview</a></span></dt><dt><span class="section"><a href="#brick-simple-add">3.2. brick_simple:add/6</a></span></dt><dt><span class="section"><a href="#brick-simple-replace">3.3. brick_simple:replace/6</a></span></dt><dt><span class="section"><a href="#brick-simple-set">3.4. brick_simple:set/6</a></span></dt><dt><span class="section"><a href="#brick-simple-get">3.5. brick_simple:get/4</a></span></dt><dt><span class="section"><a href="#brick-simple-get-many">3.6. brick_simple:get_many/5</a></span></dt><dt><span class="section"><a href="#brick-simple-delete">3.7. brick_simple:delete/4</a></span></dt><dt><span class="section"><a href="#brick-simple-do">3.8. brick_simple:do/4</a></span></dt></dl></dd><dt><span class="section"><a href="#client-api-ubf">4. Client API: UBF</a></span></dt><dd><dl><dt><span class="section"><a href="#hibari-server-impl-of-ubf-proto-stack">4.1. The Hibari Server’s Implementation of the UBF Protocol Stack</a></span></dt><dt><span class="section"><a href="#ubf-representation-of-strings">4.2. UBF representation of strings vs. binaries</a></span></dt><dt><span class="section"><a href="#using-ubf-in-any-language">4.3. Steps for Using a UBF-based Protocol in Any Language</a></span></dt><dt><span class="section"><a href="#the-hibari-ubf-protocol-contract">4.4. The Hibari UBF Protocol Contract</a></span></dt><dt><span class="section"><a href="#using-ubf-erlang-client">4.5. Using the UBF Client Library for Erlang</a></span></dt><dt><span class="section"><a href="#using-ubf-java-client">4.6. Using the UBF Client Library for Java</a></span></dt><dt><span class="section"><a href="#using-ubf-python-client">4.7. Using the EBF Client Library for Python</a></span></dt></dl></dd><dt><span class="section"><a href="#client-api-tbf">5. Client API: Thrift</a></span></dt><dd><dl><dt><span class="section"><a href="#_the_hibari_thrift_api">5.1. The Hibari Thrift API</a></span></dt><dt><span class="section"><a href="#_mapping_ubf_contract_types_to_thrift_types">5.2. Mapping UBF Contract Types to Thrift Types</a></span></dt><dt><span class="section"><a href="#_mapping_ubf_contract_to_thrift_service">5.3. Mapping UBF Contract to Thrift Service</a></span></dt><dt><span class="section"><a href="#_examples_of_using_a_thrift_client">5.4. Examples of using a Thrift client</a></span></dt><dt><span class="section"><a href="#_mapping_tbf_contract_responses_from_thrift_client">5.5. Mapping TBF Contract Responses From Thrift Client</a></span></dt></dl></dd><dt><span class="section"><a href="#_developer_utilities">6. Developer Utilities</a></span></dt><dd><dl><dt><span class="section"><a href="#_basho_bench">6.1. Basho Bench</a></span></dt><dt><span class="section"><a href="#_yahoo_cloud_serving_benchmark">6.2. Yahoo! Cloud Serving Benchmark</a></span></dt></dl></dd><dt><span class="section"><a href="#HibariBuildingSource">7. Building Hibari from Source</a></span></dt><dd><dl><dt><span class="section"><a href="#_hibari_release_package">7.1. Hibari Release Package</a></span></dt><dt><span class="section"><a href="#HibariAsciiDoc">7.2. Hibari Documentation</a></span></dt><dt><span class="section"><a href="#ErlangOTP">7.3. Erlang/OTP System</a></span></dt></dl></dd><dt><span class="section"><a href="#_sample_application">8. Sample Application</a></span></dt></dl></div><p></p><div class="section" title="1.&#xA0;Introduction"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_introduction"></a>1. Introduction</h2></div></div></div><p><span class="emphasis"><em>Under Construction</em></span></p><div class="section" title="1.1.&#xA0;Why NoSQL?"><div class="titlepage"><div><div><h3 class="title"><a id="_why_nosql"></a>1.1. Why NoSQL?</h3></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="1.2.&#xA0;Why Hibari?"><div class="titlepage"><div><div><h3 class="title"><a id="_why_hibari"></a>1.2. Why Hibari?</h3></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="1.3.&#xA0;How Hibari Works"><div class="titlepage"><div><div><h3 class="title"><a id="_how_hibari_works"></a>1.3. How Hibari Works</h3></div></div></div><div class="section" title="Data Model"><div class="titlepage"><div><div><h4 class="title"><a id="_data_model"></a>Data Model</h4></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="Partitioning Across Chains"><div class="titlepage"><div><div><h4 class="title"><a id="_partitioning_across_chains"></a>Partitioning Across Chains</h4></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="Replication Within Chains"><div class="titlepage"><div><div><h4 class="title"><a id="_replication_within_chains"></a>Replication Within Chains</h4></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="RAM and Disk Storage"><div class="titlepage"><div><div><h4 class="title"><a id="_ram_and_disk_storage"></a>RAM and Disk Storage</h4></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="Admin Server"><div class="titlepage"><div><div><h4 class="title"><a id="_admin_server"></a>Admin Server</h4></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div></div></div><div class="section" title="2.&#xA0;Getting Started"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_getting_started"></a>2. Getting Started</h2></div></div></div><p><span class="emphasis"><em>Under Construction</em></span></p><div class="section" title="2.1.&#xA0;Requirements"><div class="titlepage"><div><div><h3 class="title"><a id="_requirements"></a>2.1. Requirements</h3></div></div></div><div class="section" title="System Requirements"><div class="titlepage"><div><div><h4 class="title"><a id="_system_requirements"></a>System Requirements</h4></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="Required Software"><div class="titlepage"><div><div><h4 class="title"><a id="_required_software"></a>Required Software</h4></div></div></div><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
OpenSSL - <a class="ulink" href="http://www.openssl.org/" target="_top">http://www.openssl.org/</a>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<span class="emphasis"><em>required for Erlang’s crypto module</em></span>
</li></ul></div></li></ul></div></div></div><div class="section" title="2.2.&#xA0;Downloading Hibari"><div class="titlepage"><div><div><h3 class="title"><a id="_downloading_hibari"></a>2.2. Downloading Hibari</h3></div></div></div><p>A Hibari pre-built release has 2 files:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
a tarball package "hibari-X.Y.Z-DIST-ARCH-WORDSIZE.tgz"
</li><li class="listitem">
a md5sum file "hibari-X.Y.Z-DIST-ARCH-WORDSIZE-md5sum.txt"
</li></ul></div><p><span class="emphasis"><em>X.Y.Z</em></span> is the release version, <span class="emphasis"><em>DIST</em></span> is the release distribution,
<span class="emphasis"><em>ARCH</em></span> is the release architecture, and <span class="emphasis"><em>WORDSIZE</em></span> is the release
wordsize.</p><p>Hibari pre-built releases are not available for download yet.  See
<a class="xref" href="#HibariBuildingSource" title="7.&#xA0;Building Hibari from Source">Section 7, “Building Hibari from Source”</a> for instructions to build Hibari from source
for your target platform.</p></div><div class="section" title="2.3.&#xA0;Installing Hibari"><div class="titlepage"><div><div><h3 class="title"><a id="_installing_hibari"></a>2.3. Installing Hibari</h3></div></div></div><div class="section" title="Single Node"><div class="titlepage"><div><div><h4 class="title"><a id="_single_node"></a>Single Node</h4></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Create directory for running Hibari
</p><pre class="screen">$ mkdir running-directory-name</pre></li><li class="listitem"><p class="simpara">
Untar release files
</p><pre class="screen">$ tar -C running-directory-name -xvf hibari-X.Y.Z-DIST-ARCH-WORDSIZE.tgz</pre></li></ol></div></div><div class="section" title="Multi Node"><div class="titlepage"><div><div><h4 class="title"><a id="_multi_node"></a>Multi Node</h4></div></div></div><p>Cluster is a simple tool for installing, configuring, and
bootstrapping a cluster of Hibari nodes. The cluster tool requires one
installer node and one or more target nodes for the Hibari cluster.
The installer node can be a different node or can be one of the target
nodes.  The cluster tool requires an installing user (that is you) and
it must be different than the user for Hibari on the target nodes.</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>This tool should meet the needs of most users.  However, this
tool’s "target node" recipe is currently Linux-centric (e.g. useradd,
userdel, …).  Patches and contributions for other OS and platforms
are welcome.  For non-Linux deployments, the cluster tool is rather
simple so installation can be done manually by following the tool’s
recipe.</p></td></tr></table></div><p>Your Hibari installer node must have following tools/environments
ready.  For further information and help for related tools, please
refer to the following links:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Bash - <a class="ulink" href="http://www.gnu.org/software/bash/" target="_top">http://www.gnu.org/software/bash/</a>
</li><li class="listitem">
Expect - <a class="ulink" href="http://www.nist.gov/el/msid/expect.cfm" target="_top">http://www.nist.gov/el/msid/expect.cfm</a>
</li><li class="listitem"><p class="simpara">
Git - <a class="ulink" href="http://git-scm.com/" target="_top">http://git-scm.com/</a>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<span class="strong"><strong>Git 1.5.4 or newer</strong></span>
</li><li class="listitem">
<span class="emphasis"><em>required for GitHub</em></span>
</li></ul></div></li><li class="listitem">
Perl - <a class="ulink" href="http://www.perl.org/" target="_top">http://www.perl.org/</a>
</li><li class="listitem">
SSH (client) - <a class="ulink" href="http://www.openssh.com/" target="_top">http://www.openssh.com/</a>
</li></ul></div><p>Your Hibari target nodes must have following tools/environments ready.
For further information and help for related tools, please refer to
the following links:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
SSH (server) - <a class="ulink" href="http://www.openssh.com/" target="_top">http://www.openssh.com/</a>
</li></ul></div><p>So far, there are no "known" version requirements for Bash, Expect,
Perl, and SSH.</p><div class="section" title="Prerequisites and Assumptions"><div class="titlepage"><div><div><h5 class="title"><a id="_prerequisites_and_assumptions"></a>Prerequisites and Assumptions</h5></div></div></div><div class="orderedlist"><ol class="orderedlist" type="A"><li class="listitem"><p class="simpara">
1 installer node
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Bash, Expect, Git, Perl, Python, and SSH (client) is installed
     on installer node
</li><li class="listitem">
Your login account ($USER) exists on installer node with ssh
     private/public keys and ssh agent setup to enable password-less
     ssh login
</li><li class="listitem">
/etc/hosts file on installer node contains entries for all
     target nodes
</li></ul></div></li><li class="listitem"><p class="simpara">
1 or more cluster target nodes (e.g. dev1, dev2, dev3)
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Your login account ($USER) exists on target nodes
</li><li class="listitem">
Your login account ($USER) is enabled with password-less sudo
     access on target nodes
</li><li class="listitem">
Your login account ($USER) is accessible with password-less ssh
     login on target nodes
</li><li class="listitem">
SSH (server) is installed on target nodes
</li><li class="listitem">
/etc/hosts file on target nodes contains entries for all target
     nodes
</li><li class="listitem">
Network A and Network B is setup and active (see note below)
</li></ul></div></li><li class="listitem"><p class="simpara">
Cluster configuration file. This will show up as hibari.config in
   latter explanation.  You have to manually create it on installer
   node and later provide it’s location as an input to the cluster
   tool.
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Hibari Admin nodes
</li><li class="listitem">
Hibari Brick nodes
</li><li class="listitem">
Hibari Bricks per Chain value (i.e. replication factor)
</li><li class="listitem">
All Hibari nodes (union of Admin and Brick nodes)
</li><li class="listitem">
All Hibari nodes Network A and Network B ip addresses plus
     Network broadcast addresses and Network A tiebreaker address
</li><li class="listitem"><p class="simpara">
All Heartbeat UDP ports
</p><p class="simpara">Example configuration file (hibari.config) for a three node cluster
that uses the same physical network for Network A and Network B (see
note below):</p><pre class="screen">ADMIN_NODES=(dev1 dev2 dev3)
BRICK_NODES=(dev1 dev2 dev3)
BRICKS_PER_CHAIN=2

ALL_NODES=(dev1 dev2 dev3)
ALL_NETA_ADDRS=("10.181.165.230" "10.181.165.231" "10.181.165.232")
ALL_NETB_ADDRS=("10.181.165.230" "10.181.165.231" "10.181.165.232")
ALL_NETA_BCAST="10.181.165.255"
ALL_NETB_BCAST="10.181.165.255"
ALL_NETA_TIEBREAKER="10.181.165.1"

ALL_HEART_UDP_PORT="63099"
ALL_HEART_XMIT_UDP_PORT="63100"</pre><p class="simpara">Example /etc/hosts file entries for above configuration:</p><pre class="screen">10.181.165.230  dev1.your-domain.com    dev1
10.181.165.231  dev2.your-domain.com    dev2
10.181.165.232  dev3.your-domain.com    dev3</pre><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>See
<a class="ulink" href="http://hibari.github.com/hibari-doc/hibari-sysadmin-guide.en.html#partition-detector" target="_top">http://hibari.github.com/hibari-doc/hibari-sysadmin-guide.en.html#partition-detector</a>
for further information regarding the network partition detector
application, Network A, and Network B.  Additional information for the
application’s configuration is embedded in the partition-detector’s
OTP application source file
(<a class="ulink" href="https://github.com/hibari/partition-detector/raw/master/src/partition_detector.app.src" target="_top">https://github.com/hibari/partition-detector/raw/master/src/partition_detector.app.src</a>).</p></td></tr></table></div><div class="caution" title="Caution" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/icons/caution.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>In a production setting, Network A and Network B should be
physically different networks and network interfaces.  However, the
same network can be used (as in this example) for Network A and
Network B for testing and development purposes.</p></td></tr></table></div><div class="caution" title="Caution" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/icons/caution.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Currently hostname must not contain "-" (minus).  If hostname
contain "-", like dev-1 for example, your Hibari cluster will not
startup. This will be fixed in future release and this sentence will
be deleted at that time. Thanks for your patience.</p></td></tr></table></div></li></ul></div></li></ol></div></div><div class="section" title="Example how to prepare installing user"><div class="titlepage"><div><div><h5 class="title"><a id="_example_how_to_prepare_installing_user"></a>Example how to prepare installing user</h5></div></div></div><p>Setup your user (i.e. your login - $USER) on all Hibari nodes if not
already existing.  This user will only be used for Hibari installation
purposes.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
As root user, add your user to all of the Hibari nodes and grant
   sudo access for your user.
</p><pre class="screen">$ useradd $USER
$ passwd $USER
$ visudo
# append the following line and save it
$USER  ALL=(ALL)       NOPASSWD: ALL</pre><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>If you get "sudo: sorry, you must have a tty to run sudo" error
while testing <span class="emphasis"><em>sudo</em></span>, consider to comment out following line inside of
the /etc/sudoers file:</p></td></tr></table></div><pre class="screen">$ visudo
Defaults    requiretty</pre></li><li class="listitem"><p class="simpara">
Create a new ssh private/public key for your user on the installer
   node.
</p><pre class="screen">$ ssh-keygen
# enter your password for the private key
$ eval `ssh-agent`
$ ssh-add ~/.ssh/id_rsa
# re-enter your password for the private key</pre></li><li class="listitem"><p class="simpara">
Append an entry for the installer node to your ~/.ssh/known_hosts
   file on each of the Hibari nodes and append an entry to your
   ~/.ssh/authorized_keys file on all of the Hibari nodes for your
   public ssh key.
</p><pre class="screen">$ ssh-copy-id -i ~/.ssh/id_rsa.pub $USER@dev1
$ ssh-copy-id -i ~/.ssh/id_rsa.pub $USER@dev2
$ ssh-copy-id -i ~/.ssh/id_rsa.pub $USER@dev3</pre><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>If your installer node will be one of the Hibari cluster nodes,
make sure that you ssh-copy-id to the installer node also.</p></td></tr></table></div></li><li class="listitem"><p class="simpara">
Confirm password-less access to the each of the Hibari nodes works
as expected.
</p><pre class="screen">$ ssh $USER@dev1
$ ssh $USER@dev2
$ ssh $USER@dev3</pre></li></ol></div><div class="tip" title="Tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/tip.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>If needed, check
<a class="ulink" href="http://inside.mines.edu/~gmurray/HowTo/sshNotes.html" target="_top">http://inside.mines.edu/~gmurray/HowTo/sshNotes.html</a> for further SSH
setup help.</p></td></tr></table></div></div><div class="section" title="Example how to prepare installer node"><div class="titlepage"><div><div><h5 class="title"><a id="_example_how_to_prepare_installer_node"></a>Example how to prepare installer node</h5></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Configure your e-mail and name for Git
</p><pre class="screen">$ git config --global user.email "you@example.com"
$ git config --global user.name "Your Name"</pre></li><li class="listitem"><p class="simpara">
Create working directory
</p><pre class="screen">$ mkdir working-directory-name</pre></li><li class="listitem"><p class="simpara">
Download cluster tool’s Git repository
</p><pre class="screen">$ cd working-directory-name
$ git clone git://github.com/hibari/clus.git</pre></li><li class="listitem"><p class="simpara">
Place a copy of the Hibari pre-built release and your hibari.config
   file into the working directory.
</p><pre class="screen">$ cd working-directory-name
$ ls -1
clus
hibari-X.Y.Z-DIST-ARCH-WORDSIZE-md5sum.txt
hibari-X.Y.Z-DIST-ARCH-WORDSIZE.tgz
hibari.config
$</pre></li></ol></div></div><div class="section" title="Example how to create all Hibari nodes"><div class="titlepage"><div><div><h5 class="title"><a id="_example_how_to_create_all_hibari_nodes"></a>Example how to create all Hibari nodes</h5></div></div></div><p>All of the operations below are run on the installer node via two Bash
scripts (i.e. clus.sh and clus-hibari.sh).</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Create (or re-create) "hibari" user on all Hibari nodes
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>If your ssh private key is protected by a password, please make
sure your private key is registered with the ssh agent before
proceeding.</p></td></tr></table></div><pre class="screen">$ cd working-directory-name
$ for i in dev1 dev2 dev3 ; do ./clus/priv/clus.sh -f init hibari $i ; done
hibari@dev1
hibari@dev2
hibari@dev3</pre><div class="caution" title="Caution" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/icons/caution.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>The -f option will forcefully delete and then re-create
the "hibari" user on the target node.</p></td></tr></table></div></li><li class="listitem"><p class="simpara">
Copy pre-built release to all Hibari nodes and then setup Hibari
   package on all Hibari nodes via the "hibari" user.
</p><pre class="screen">$ cd working-directory-name
$ ./clus/priv/clus-hibari.sh -f init hibari hibari.config hibari-X.Y.Z-DIST-ARCH-WORDSIZE.tgz
hibari@dev1
hibari@dev2
hibari@dev3</pre></li></ol></div><div class="tip" title="Tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/tip.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>As described in the next section, the clus-hibari.sh script can
be used for starting and stopping of a Hibari multi node cluster even
after it’s creation.</p></td></tr></table></div></div></div></div><div class="section" title="2.4.&#xA0;Deploying a Simple Hibari System"><div class="titlepage"><div><div><h3 class="title"><a id="_deploying_a_simple_hibari_system"></a>2.4. Deploying a Simple Hibari System</h3></div></div></div><div class="section" title="Single Node"><div class="titlepage"><div><div><h4 class="title"><a id="_single_node_2"></a>Single Node</h4></div></div></div><div class="section" title="Basic Configuration"><div class="titlepage"><div><div><h5 class="title"><a id="_basic_configuration"></a>Basic Configuration</h5></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="Starting a Single Node Cluster"><div class="titlepage"><div><div><h5 class="title"><a id="_starting_a_single_node_cluster"></a>Starting a Single Node Cluster</h5></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Start Hibari
</p><pre class="screen">$ running-directory-name/hibari/bin/hibari start</pre></li><li class="listitem"><p class="simpara">
Bootstrap Hibari
</p><pre class="screen">$ running-directory-name/hibari/bin/hibari-admin bootstrap</pre><p class="simpara">The Hibari bootstrap process starts Hibari’s Admin server on the
single node and creates a single table "tab1" serving as Hibari’s
default table.</p></li></ol></div></div><div class="section" title="Verifying Your System"><div class="titlepage"><div><div><h5 class="title"><a id="_verifying_your_system"></a>Verifying Your System</h5></div></div></div><p>A few simple operations to verify system is set up properly.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Open "Hibari Web Administration" page
</p><pre class="screen">$ your-favorite-browser http://127.0.0.1:23080</pre></li><li class="listitem"><p class="simpara">
Ping node to check the health.
</p><pre class="screen">$ running-directory-name/hibari/bin/hibari ping</pre></li></ol></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="Creating Other Tables"><div class="titlepage"><div><div><h5 class="title"><a id="_creating_other_tables"></a>Creating Other Tables</h5></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="Stopping a Single Node Cluster"><div class="titlepage"><div><div><h5 class="title"><a id="_stopping_a_single_node_cluster"></a>Stopping a Single Node Cluster</h5></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Stop Hibari
</p><pre class="screen">$ running-directory-name/hibari/bin/hibari stop</pre></li></ol></div></div></div><div class="section" title="Multi Node"><div class="titlepage"><div><div><h4 class="title"><a id="_multi_node_2"></a>Multi Node</h4></div></div></div><div class="section" title="Basic Configuration"><div class="titlepage"><div><div><h5 class="title"><a id="_basic_configuration_2"></a>Basic Configuration</h5></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="Starting a Multi Node Cluster"><div class="titlepage"><div><div><h5 class="title"><a id="_starting_a_multi_node_cluster"></a>Starting a Multi Node Cluster</h5></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Start Hibari on all Hibari nodes via the "hibari" user
</p><pre class="screen">$ cd working-directory-name
$ ./clus/priv/clus-hibari.sh -f start hibari hibari.config
hibari@dev1
hibari@dev2
hibari@dev3</pre></li><li class="listitem"><p class="simpara">
Bootstrap Hibari on first Hibari admin node via the "hibari" user
</p><pre class="screen">$ cd working-directory-name
$ ./clus/priv/clus-hibari.sh -f bootstrap hibari hibari.config
hibari@dev1 =&gt; hibari@dev1 hibari@dev2 hibari@dev3</pre><p class="simpara">The Hibari bootstrap process starts Hibari’s admin server on the first
admin node and creates a single table "tab1" serving as Hibari’s
default table.</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>If bootstrapping fails due to "another_admin_server_running"
error, please stop the other Hibari cluster(s) running on the network
or repeat the installation from the beginning with udp ports
(i.e. ALL_HEART_UDP_PORT and ALL_HEART_XMIT_UDP_PORT) that are not in
use by other applications or another Hibari cluster.</p></td></tr></table></div></li></ol></div></div><div class="section" title="Verifying Your System"><div class="titlepage"><div><div><h5 class="title"><a id="_verifying_your_system_2"></a>Verifying Your System</h5></div></div></div><p>A few simple operations to verify system is set up properly.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Open "Hibari Web Administration" page
</p><pre class="screen">$ your-favorite-browser http://dev1:23080</pre></li><li class="listitem"><p class="simpara">
Ping each of the nodes to check the health.
</p><pre class="screen">$ cd working-directory-name
$ ./clus/priv/clus-hibari.sh -f ping hibari hibari.config
hibari@dev1 ... pong
hibari@dev2 ... pong
hibari@dev3 ... pong</pre></li></ol></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="Creating Other Tables"><div class="titlepage"><div><div><h5 class="title"><a id="_creating_other_tables_2"></a>Creating Other Tables</h5></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="Stopping a Multi Node Cluster"><div class="titlepage"><div><div><h5 class="title"><a id="_stopping_a_multi_node_cluster"></a>Stopping a Multi Node Cluster</h5></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Stop Hibari on all Hibari nodes via the "hibari" user
</p><pre class="screen">$ cd working-directory-name
$ ./clus/priv/clus-hibari.sh -f stop hibari hibari.config
ok
ok
ok
hibari@dev1
hibari@dev2
hibari@dev3</pre></li></ol></div></div></div></div></div><div class="section" title="3.&#xA0;Client API: Native Erlang"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="client-api-erlang"></a>3. Client API: Native Erlang</h2></div></div></div><div class="section" title="3.1.&#xA0;Overview"><div class="titlepage"><div><div><h3 class="title"><a id="_overview"></a>3.1. Overview</h3></div></div></div><p>As a key-value database, Hibari provides a simple client API with primitive operations for inserting, retrieving, and deleting data. Within certain restrictions, the API also supports compound operations that optionally can be executed as all-or-nothing transactions.</p><p>More specifically, Hibari’s client API supports the operations listed below. For details on the native Erlang API for each operation, follow the links.</p><p><span class="strong"><strong>Data Insertion</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
Add a key-value pair that does not yet exist, along with optional flags:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<a class="ulink" href="#brick-simple-add" target="_top">brick_simple:add/6</a>
</li></ul></div></li><li class="listitem"><p class="simpara">
Assign a new value and/or new flags to a key that already exists:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<a class="ulink" href="#brick-simple-replace" target="_top">brick_simple:replace/6</a>
</li></ul></div></li><li class="listitem"><p class="simpara">
Set a key-value pair and optional flags regardless of whether the key yet exists:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<a class="ulink" href="#brick-simple-set" target="_top">brick_simple:set/6</a>
</li></ul></div></li></ul></div><p><span class="strong"><strong>Data Retrieval</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
Retrieve a key and optionally its associated value and flags:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<a class="ulink" href="#brick-simple-get" target="_top">brick_simple:get/4</a>
</li></ul></div></li><li class="listitem"><p class="simpara">
Retrieve multiple lexicographically contiguous keys and optionally their associated values and flags:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<a class="ulink" href="#brick-simple-get-many" target="_top">brick_simple:get_many/5</a>
</li></ul></div></li></ul></div><p><span class="strong"><strong>Data Deletion</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
Delete a key-value pair and associated flags:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<a class="ulink" href="#brick-simple-delete" target="_top">brick_simple:delete/4</a>
</li></ul></div></li></ul></div><p><span class="strong"><strong>Compound Operations</strong></span></p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
Execute a specified list of operations, optionally as an all-or-nothing transaction:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<a class="ulink" href="#brick-simple-do" target="_top">brick_simple:do/4</a>
</li></ul></div></li></ul></div><p>If desired, clients can apply a "test 'n set" logic to data insertion, retrieval, and deletion operations so that the operation will be executed only if the target key has the exact timestamp specified in the request.</p><div class="section" title="Erlang Basic Data Types"><div class="titlepage"><div><div><h4 class="title"><a id="_erlang_basic_data_types"></a>Erlang Basic Data Types</h4></div></div></div><p>The following provides a high level introduction to Erlang basic data types that are referenced in this chapter. This material is excerpted with minor modifications from the <a class="ulink" href="http://www.erlang.org/doc/reference_manual/data_types.html" target="_top">official Erlang documentation on data types</a>. For further information, see the official Erlang documentation.</p><div class="important" title="Important" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/important.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>All Erlang commands must conclude with a period (.).</p></td></tr></table></div><div class="variablelist"><dl><dt><span class="term">
Term
</span></dt><dd>
A piece of data of any data type is called a <span class="strong"><strong>term</strong></span>.
</dd><dt><span class="term">
Number
</span></dt><dd>
There are two types of numeric literals, <span class="strong"><strong>integers</strong></span> and <span class="strong"><strong>floats</strong></span>.
</dd><dt><span class="term">
Atom
</span></dt><dd><p class="simpara">
An <span class="strong"><strong>atom</strong></span> is a literal, a constant with name. An atom should be enclosed in single quotes (') if it does not begin with a lower-case letter or if it contains other characters than alphanumeric characters, underscore (_), or @. Optionally, any atom can be enclosed in single quotes. For example:
</p><pre class="screen">hello
phone_number
'Monday'
'phone number'
'hello'
'phone_number'</pre></dd><dt><span class="term">
Bit String and Binary
</span></dt><dd><p class="simpara">
A <span class="strong"><strong>bit string</strong></span> is used to store an area of untyped memory. Bit strings are expressed using <a class="ulink" href="http://www.erlang.org/doc/reference_manual/expressions.html#bit_syntax" target="_top">Erlang bit syntax</a>. A bit string that consists of a number of bits that is evenly divisible by eight is called a <span class="strong"><strong>binary</strong></span>. For example:
</p><pre class="screen">&lt;&lt;10,20&gt;&gt;
&lt;&lt;"ABC"&gt;&gt;</pre></dd><dt><span class="term">
Tuple
</span></dt><dd><p class="simpara">
A <span class="strong"><strong>tuple</strong></span> is a compound data type with a fixed number of terms, enclosed by braces:
</p><pre class="screen">{Term1,...,TermN}</pre></dd><dt><span class="term">
List
</span></dt><dd><p class="simpara">
A <span class="strong"><strong>list</strong></span> is a compound data type with a variable number of terms, enclosed by square brackets:
</p><pre class="screen">[Term1,...,TermN]</pre></dd><dt><span class="term">
String
</span></dt><dd>
Strings are enclosed in double quotes ("), but are not a true data type in Erlang. Instead a string "hello" is shorthand for the list [$h,$e,$l,$l,$o], that is [104,101,108,108,111].
</dd><dt><span class="term">
Boolean
</span></dt><dd>
There is no Boolean data type in Erlang. Instead the atoms <code class="literal">true</code> and <code class="literal">false</code> are used to denote Boolean values.
</dd></dl></div></div></div><div class="section" title="3.2.&#xA0;brick_simple:add/6"><div class="titlepage"><div><div><h3 class="title"><a id="brick-simple-add"></a>3.2. brick_simple:add/6</h3></div></div></div><p>SYNOPSIS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd>
<span class="strong"><strong>brick_simple:add(Tab, Key, Value, ExpTime, Flags, Timeout).</strong></span>
</dd></dl></div><p>DESCRIPTION</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd>
Add <code class="literal">Key</code> and <code class="literal">Value</code> pair (and optional <code class="literal">Flags</code>) to the table <code class="literal">Tab</code> if the key does not already exist.  The operation will fail if <code class="literal">Key</code> already exists.
</dd></dl></div><p>PARAMETERS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Tab</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Name of the table to which to add the key-value pair.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Tab = table()</code>
</li><li class="listitem">
<code class="literal">table() = atom()</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Key</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Key to add to the table, in association with a paired value.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Key = key()</code>
</li><li class="listitem">
<code class="literal">key() = iodata()</code>
</li><li class="listitem">
<code class="literal">iodata() = iolist() | binary()</code>
</li><li class="listitem"><p class="simpara">
<code class="literal">iolist()  = [char() | binary() | iolist()]</code>
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>While the <code class="literal">Key</code> may be specified as either <code class="literal">iolist()</code> or <code class="literal">binary()</code>, it will be converted into binary before operation execution. The same is true of <code class="literal">Value</code>.</p></td></tr></table></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Value</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Value to associate with the key.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Value = val()</code>
</li><li class="listitem">
<code class="literal">val() = iodata()</code>
</li><li class="listitem">
<code class="literal">iodata() = iolist() | binary()</code>
</li><li class="listitem">
<code class="literal">iolist()  = [char() | binary() | iolist()]</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>ExpTime</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Time at which the key will expire, expressed as a Unix time_t().
</li><li class="listitem">
Optional; defaults to 0 (no expiration).
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">ExpTime = exp_time()</code>
</li><li class="listitem">
<code class="literal">exp_time() = time_t()</code>
</li><li class="listitem">
<code class="literal">time_t() = integer()</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Flags</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
List of operational flags to apply to the ‘add’ operation, and/or custom property flags to associate with the key-value pair in the database. Heavy use of custom property flags is discouraged due to RAM-based storage.
</li><li class="listitem">
Optional; defaults to empty list.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Flags = flags_list()</code>
</li><li class="listitem">
<code class="literal">flags_list() = [do_op_flag() | property()]</code>
</li><li class="listitem">
<code class="literal">do_op_flag() = 'value_in_ram'</code>
</li><li class="listitem">
<code class="literal">property() = atom() | {term(), term()}</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
Operational flag usage
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p class="simpara">
<code class="literal">'value_in_ram'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem"><p class="simpara">
Store the value blob in RAM, overriding the default storage location of the brick.
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>This flag has not yet been extensively tested by Gemini QA.</p></td></tr></table></div></li></ul></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Timeout</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Operation timeout in milliseconds.
</li><li class="listitem">
Optional; defaults to 15000.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Timeout = timeout()</code>
</li><li class="listitem">
<code class="literal">timeout() = integer() | 'infinity'</code>
</li></ul></div></li></ul></div></dd></dl></div><p>RETURNS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Success return
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">'ok'</code>
</li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Error returns
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
<code class="literal">{'key_exists',timestamp()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the key already exists.
</li><li class="listitem">
<code class="literal">timestamp() = integer()</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'invalid_flag_present'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because an invalid <code class="literal">do_op_flag()</code> was found in the <code class="literal">Flags</code> argument.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'brick_not_available'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the chain that is responsible for this key is currently length zero and therefore unavailable.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{{'nodedown',node()},{'gen_server','call',term()}}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the server brick handling the request has crashed or else a network partition has occurred between the client and server. The client should resend the query after a short delay, on the assumption that the Admin Server will have detected the failure and taken steps to repair the chain.
</li><li class="listitem">
<code class="literal">node() = atom()</code>
</li></ul></div></li></ul></div></dd></dl></div><p>ALIASES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
brick_simple:add/3
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:add(Tab, Key, Value).</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
brick_simple:add/4
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:add(Tab, Key, Value, Flags).</code>
</li><li class="listitem">
<code class="literal">brick_simple:add(Tab, Key, Value, Timeout).</code>
</li></ul></div></li></ul></div></dd></dl></div><p>EXAMPLES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful adding of a new key-value pair:
</p><pre class="screen">&gt; brick_simple:add(tab1, &lt;&lt;"foo"&gt;&gt;, &lt;&lt;"Hello, world!"&gt;&gt;).
ok</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Failed attempt to add a key that already exists:
</p><pre class="screen">&gt; brick_simple:add(tab1, &lt;&lt;"foo"&gt;&gt;, &lt;&lt;"Goodbye, world!"&gt;&gt;).
{key_exists,1271542959131192}</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful adding of a new key-value pair, with value to be stored in RAM regardless of brick’s default storage setting:
</p><pre class="screen">&gt; brick_simple:add(tab1, "foo1", "this is value1", ['value_in_ram']).
ok</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful adding of a new key-value pair, using a non-default operation timeout:
</p><pre class="screen">&gt; brick_simple:add(tab1, "foo2", "this is value2", 20000).
ok</pre></dd></dl></div></div><div class="section" title="3.3.&#xA0;brick_simple:replace/6"><div class="titlepage"><div><div><h3 class="title"><a id="brick-simple-replace"></a>3.3. brick_simple:replace/6</h3></div></div></div><p>SYNOPSIS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd>
<span class="strong"><strong>brick_simple:replace(Tab, Key, Value, ExpTime, Flags, Timeout).</strong></span>
</dd></dl></div><p>DESCRIPTION</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd>
Replace <code class="literal">Key</code> and <code class="literal">Value</code> pair (and optional <code class="literal">Flags</code>) in the table <code class="literal">Tab</code> if the key already exists.  The operation will fail if <code class="literal">Key</code> does not already exist.
</dd></dl></div><p>PARAMETERS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Tab</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Name of the table in which to replace the key-value pair.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Tab = table()</code>
</li><li class="listitem">
<code class="literal">table() = atom()</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Key</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Key to replace in the table, in association with a new paired value.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Key = key()</code>
</li><li class="listitem">
<code class="literal">key() = iodata()</code>
</li><li class="listitem">
<code class="literal">iodata() = iolist() | binary()</code>
</li><li class="listitem"><p class="simpara">
<code class="literal">iolist()  = [char() | binary() | iolist()]</code>
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>While the <code class="literal">Key</code> may be specified as either <code class="literal">iolist()</code> or <code class="literal">binary()</code>, it will be converted into binary before operation execution. The same is true of <code class="literal">Value</code>.</p></td></tr></table></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Value</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
New value to associate with the key.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Value = val()</code>
</li><li class="listitem">
<code class="literal">val() = iodata()</code>
</li><li class="listitem">
<code class="literal">iodata() = iolist() | binary()</code>
</li><li class="listitem">
<code class="literal">iolist()  = [char() | binary() | iolist()]</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>ExpTime</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Time at which the key will expire, expressed as a Unix time_t().
</li><li class="listitem">
Optional; defaults to 0 (no expiration).
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">ExpTime = exp_time()</code>
</li><li class="listitem">
<code class="literal">exp_time() = time_t()</code>
</li><li class="listitem">
<code class="literal">time_t() = integer()</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Flags</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
List of operational flags to apply to the ‘replace’ operation, and/or custom property flags to associate with the key-value pair in the database. Heavy use of custom property flags is discouraged due to RAM-based storage.
</li><li class="listitem">
Optional; defaults to empty list.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Flags = flags_list()</code>
</li><li class="listitem">
<code class="literal">flags_list() = [do_op_flag() | property()]</code>
</li><li class="listitem">
<code class="literal">do_op_flag() = {'testset', timestamp()} |'value_in_ram'</code>
</li><li class="listitem">
<code class="literal">timestamp() = integer()</code>
</li><li class="listitem">
<code class="literal">property() = atom() | {term(), term()}</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
Operational flag usage
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p class="simpara">
<code class="literal">{'testset', timestamp()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
Fail the operation if the existing key’s timestamp is not exactly equal to <code class="literal">timestamp()</code>.  If used inside a <a class="ulink" href="#brick-simple-do" target="_top">micro-transaction</a>, abort the transaction if the key’s timestamp is not exactly equal to <code class="literal">timestamp()</code>.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'value_in_ram'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem"><p class="simpara">
Store the value blob in RAM, overriding the default storage location of the brick.
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>This flag has not yet been extensively tested by Gemini QA.</p></td></tr></table></div></li></ul></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Timeout</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Operation timeout in milliseconds.
</li><li class="listitem">
Optional; defaults to 15000.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Timeout = timeout()</code>
</li><li class="listitem">
<code class="literal">timeout() = integer() | 'infinity'</code>
</li></ul></div></li></ul></div></dd></dl></div><p>RETURNS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Success return
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">'ok'</code>
</li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Error returns
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
<code class="literal">'key_not_exist'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the key does not exist.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{'ts_error', timestamp()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the <code class="literal">{'testset', timestamp()}</code> flag was used and there was a timestamp mismatch. The <code class="literal">timestamp()</code> in the return is the current value of the existing key’s timestamp.
</li><li class="listitem">
<code class="literal">timestamp() = integer()</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'invalid_flag_present'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because an invalid <code class="literal">do_op_flag()</code> was found in the <code class="literal">Flags</code> argument.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'brick_not_available'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the chain that is responsible for this key is currently length zero and therefore unavailable.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{{'nodedown',node()},{'gen_server','call',term()}}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the server brick handling the request has crashed or else a network partition has occurred between the client and server. The client should resend the query after a short delay, on the assumption that the Admin Server will have detected the failure and taken steps to repair the chain.
</li><li class="listitem">
<code class="literal">node() = atom()</code>
</li></ul></div></li></ul></div></dd></dl></div><p>ALIASES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
brick_simple:replace/3
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:replace(Tab, Key, Value).</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
brick_simple:replace/4
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:replace(Tab, Key, Value, Flags).</code>
</li><li class="listitem">
<code class="literal">brick_simple:replace(Tab, Key, Value, Timeout).</code>
</li></ul></div></li></ul></div></dd></dl></div><p>EXAMPLES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful replacement of a key-value pair:
</p><pre class="screen">&gt; brick_simple:replace(tab1, &lt;&lt;"foo"&gt;&gt;, &lt;&lt;"Goodbye, world!"&gt;&gt;).
ok</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Failed attempt to replace a key that does not yet exist:
</p><pre class="screen">&gt; brick_simple:replace(tab1, &lt;&lt;"key3"&gt;&gt;, &lt;&lt;"new and improved value"&gt;&gt;).
key_not_exist</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful replacement of a key-value pair, with value to be stored in RAM regardless of brick’s default storage setting:
</p><pre class="screen">&gt; brick_simple:replace(tab1, "foo", "You again, world!", ['value_in_ram']).
ok</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Failed attempt to replace a key for which we have incorrectly specified its current timestamp:
</p><pre class="screen">&gt; brick_simple:replace(tab1, "foo", "Whole new value", [{'testset', 12345}]).
{ts_error,1271543165272987}</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful replacement of a key-value pair for which we have correctly specified its current timestamp:
</p><pre class="screen">&gt; brick_simple:replace(tab1, "foo", "Whole new value", [{'testset', 1271543165272987}]).
ok</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful replacement of a key-value pair, using a non-default operation timeout:
</p><pre class="screen">&gt; brick_simple:replace(tab1, "foo", "Foo again?", 30000).
ok</pre></dd></dl></div></div><div class="section" title="3.4.&#xA0;brick_simple:set/6"><div class="titlepage"><div><div><h3 class="title"><a id="brick-simple-set"></a>3.4. brick_simple:set/6</h3></div></div></div><p>SYNOPSIS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd>
<span class="strong"><strong>brick_simple:set(Tab, Key, Value, ExpTime, Flags, Timeout).</strong></span>
</dd></dl></div><p>DESCRIPTION</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd>
Set <code class="literal">Key</code> and <code class="literal">Value</code> pair (and optional <code class="literal">Flags</code>) in the table <code class="literal">Tab</code>, regardless of whether or not the key already exists.
</dd></dl></div><p>PARAMETERS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Tab</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Name of the table in which to set the key-value pair.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Tab = table()</code>
</li><li class="listitem">
<code class="literal">table() = atom()</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Key</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Key to set in the table, in association with a paired value.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Key = key()</code>
</li><li class="listitem">
<code class="literal">key() = iodata()</code>
</li><li class="listitem">
<code class="literal">iodata() = iolist() | binary()</code>
</li><li class="listitem"><p class="simpara">
<code class="literal">iolist()  = [char() | binary() | iolist()]</code>
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>While the <code class="literal">Key</code> may be specified as either <code class="literal">iolist()</code> or <code class="literal">binary()</code>, it will be converted into binary before operation execution. The same is true of <code class="literal">Value</code>.</p></td></tr></table></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Value</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Value to associate with the key.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Value = val()</code>
</li><li class="listitem">
<code class="literal">val() = iodata()</code>
</li><li class="listitem">
<code class="literal">iodata() = iolist() | binary()</code>
</li><li class="listitem">
<code class="literal">iolist()  = [char() | binary() | iolist()]</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>ExpTime</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Time at which the key will expire, expressed as a Unix time_t().
</li><li class="listitem">
Optional; defaults to 0 (no expiration).
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">ExpTime = exp_time()</code>
</li><li class="listitem">
<code class="literal">exp_time() = time_t()</code>
</li><li class="listitem">
<code class="literal">time_t() = integer()</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Flags</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
List of operational flags to apply to the ‘set’ operation, and/or custom property flags to associate with the key-value pair in the database. Heavy use of custom property flags is discouraged due to RAM-based storage.
</li><li class="listitem">
Optional; defaults to empty list.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Flags = flags_list()</code>
</li><li class="listitem">
<code class="literal">flags_list() = [do_op_flag() | property()]</code>
</li><li class="listitem">
<code class="literal">do_op_flag() = {'testset', timestamp()} |'value_in_ram'</code>
</li><li class="listitem">
<code class="literal">timestamp() = integer()</code>
</li><li class="listitem">
<code class="literal">property() = atom() | {term(), term()}</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
Operational flag usage
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p class="simpara">
<code class="literal">{'testset', timestamp()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
Fail the operation if the existing key’s timestamp is not exactly equal to <code class="literal">timestamp()</code>.  If used inside a <a class="ulink" href="#brick-simple-do" target="_top">micro-transaction</a>, abort the transaction if the key’s timestamp is not exactly equal to <code class="literal">timestamp()</code>. Using this flag with <code class="literal">set</code> will result in an error if the key does not already exist or if the key exists but has a non-matching timestamp.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'value_in_ram'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem"><p class="simpara">
Store the value blob in RAM, overriding the default storage location of the brick.
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>This flag has not yet been extensively tested by Gemini QA.</p></td></tr></table></div></li></ul></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Timeout</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Operation timeout in milliseconds.
</li><li class="listitem">
Optional; defaults to 15000.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Timeout = timeout()</code>
</li><li class="listitem">
<code class="literal">timeout() = integer() | 'infinity'</code>
</li></ul></div></li></ul></div></dd></dl></div><p>RETURNS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Success return
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">'ok'</code>
</li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Error returns
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
<code class="literal">'key_not_exist'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the <code class="literal">{'testset', timestamp()}</code> flag was used and the key does not exist.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{'ts_error', timestamp()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the <code class="literal">{'testset', timestamp()}</code> flag was used and there was a timestamp mismatch. The <code class="literal">timestamp()</code> in the return is the current value of the existing key’s timestamp.
</li><li class="listitem">
<code class="literal">timestamp() = integer()</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'invalid_flag_present'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because an invalid <code class="literal">do_op_flag()</code> was found in the <code class="literal">Flags</code> argument.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'brick_not_available'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the chain that is responsible for this key is currently length zero and therefore unavailable.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{{'nodedown',node()},{'gen_server','call',term()}}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the server brick handling the request has crashed or else a network partition has occurred between the client and server. The client should resend the query after a short delay, on the assumption that the Admin Server will have detected the failure and taken steps to repair the chain.
</li><li class="listitem">
<code class="literal">node() = atom()</code>
</li></ul></div></li></ul></div></dd></dl></div><p>ALIASES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
brick_simple:set/3
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:set(Tab, Key, Value).</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
brick_simple:set/4
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:set(Tab, Key, Value, Flags).</code>
</li><li class="listitem">
<code class="literal">brick_simple:set(Tab, Key, Value, Timeout).</code>
</li></ul></div></li></ul></div></dd></dl></div><p>EXAMPLES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful setting of a key-value pair:
</p><pre class="screen">&gt; brick_simple:set(tab1, &lt;&lt;"key4"&gt;&gt;, &lt;&lt;"cool value"&gt;&gt;).
ok</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful setting of a key-value pair, with value to be stored in RAM regardless of brick’s default storage setting:
</p><pre class="screen">&gt; brick_simple:set(tab1, "goo", "value6", ['value_in_ram']).
ok</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Failed attempt to set a key-value pair, when we have used the <code class="literal">testset</code> flag but the key does not yet exist:
</p><pre class="screen">&gt; brick_simple:set(tab1, "boo", "hoo", [{'testset', 1271543165272987}]).
key_not_exist</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful setting of a key-value pair, when we have used the <code class="literal">testset</code> flag and the key does already exist and its timestamp matches our specified timestamp:
</p><pre class="screen">&gt; brick_simple:set(tab1, "goo", "value7", [{'testset', 1271543165272432}]).
ok</pre></dd></dl></div></div><div class="section" title="3.5.&#xA0;brick_simple:get/4"><div class="titlepage"><div><div><h3 class="title"><a id="brick-simple-get"></a>3.5. brick_simple:get/4</h3></div></div></div><p>SYNOPSIS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd>
<span class="strong"><strong>brick_simple:get(Tab, Key, Flags, Timeout).</strong></span>
</dd></dl></div><p>DESCRIPTION</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd>
From table <code class="literal">Tab</code>, retrieve <code class="literal">Key</code> and specified attributes of the key (as determined by <code class="literal">Flags</code>).
</dd></dl></div><p>PARAMETERS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Tab</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Name of the table from which to retrieve the key.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Tab = table()</code>
</li><li class="listitem">
<code class="literal">table() = atom()</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Key</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Key to retrieve from the table.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Key = key()</code>
</li><li class="listitem">
<code class="literal">key() = iodata()</code>
</li><li class="listitem">
<code class="literal">iodata() = iolist() | binary()</code>
</li><li class="listitem"><p class="simpara">
<code class="literal">iolist()  = [char() | binary() | iolist()]</code>
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>While the <code class="literal">Key</code> may be specified as either <code class="literal">iolist()</code> or <code class="literal">binary()</code>, it will be converted into binary before operation execution.</p></td></tr></table></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Flags</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
List of operational flags to apply to the ‘get’ operation, and/or custom property flags.
</li><li class="listitem">
Optional; defaults to empty list.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Flags = flags_list()</code>
</li><li class="listitem">
<code class="literal">flags_list() = [do_op_flag() | property()]</code>
</li><li class="listitem">
<code class="literal">do_op_flag() = 'get_all_attribs' | 'witness' | {'testset', timestamp()} | 'must_exist' | 'must_not_exist'</code>
</li><li class="listitem">
<code class="literal">timestamp() = integer()</code>
</li><li class="listitem">
<code class="literal">property() = atom() | {term(), term()}</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
Operational flag usage
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p class="simpara">
<code class="literal">'get_all_attribs'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
Return all attributes of the key. May be used in combination with the <code class="literal">witness</code> flag.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'witness'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
Do not return the value blob in the result. This flag will guarantee that the brick does not require disk access to satisfy this request.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{'testset', timestamp()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
Fail the operation if the key’s timestamp is not exactly equal to <code class="literal">timestamp()</code>. If used inside a <a class="ulink" href="#brick-simple-do" target="_top">micro-transaction</a>, abort the transaction if the key’s timestamp is not exactly equal to <code class="literal">timestamp()</code>.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'must_exist'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
For use inside a <a class="ulink" href="#brick-simple-do" target="_top">micro-transaction</a>: abort the transaction if the key does not exist.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'must_not_exist'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
For use inside a <a class="ulink" href="#brick-simple-do" target="_top">micro-transaction</a>: abort the transaction if the key exists.
</li></ul></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Timeout</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Operation timeout in milliseconds.
</li><li class="listitem">
Optional; defaults to 15000.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Timeout = timeout()</code>
</li><li class="listitem">
<code class="literal">timeout() = integer() | 'infinity'</code>
</li></ul></div></li></ul></div></dd></dl></div><p>RETURNS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Success returns
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
<code class="literal">{'ok', timestamp(), val()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
Success return when the get request uses neither the <code class="literal">'witness'</code> flag nor the <code class="literal">'get_all_attribs'</code> flag.
</li><li class="listitem">
<code class="literal">timestamp() = integer()</code>
</li><li class="listitem">
<code class="literal">val() = iodata()</code>
</li><li class="listitem">
<code class="literal">iodata() = iolist() | binary()</code>
</li><li class="listitem">
<code class="literal">iolist()  = [char() | binary() | iolist()]</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{'ok', timestamp()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
Success return when the get uses <code class="literal">'witness'</code> but not <code class="literal">'get_all_attribs'</code>.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{'ok', timestamp(), proplist()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
Success return when the get uses both <code class="literal">'witness'</code> and <code class="literal">'get_all_attribs'</code>.
</li><li class="listitem">
<code class="literal">proplist() = [property()]</code>
</li><li class="listitem">
<code class="literal">property() = atom() | {term(), term()}</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{'ok', timestamp(), val(), exp_time(), proplist()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
Success return when the get uses <code class="literal">'get_all_attribs'</code> but not <code class="literal">'witness'</code>.
</li><li class="listitem"><p class="simpara">
<code class="literal">exp_time() = time_t()</code>
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>When a <code class="literal">proplist()</code> is returned, one of the properties in the list will always be <code class="literal">{val_len,Size::integer()}</code>, where <code class="literal">Size</code> is the size of the value blob in bytes.</p></td></tr></table></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Error returns
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
<code class="literal">'key_not_exist'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the key does not exist.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{'ts_error', timestamp()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the <code class="literal">{'testset', timestamp()}</code> flag was used and there was a timestamp mismatch. The <code class="literal">timestamp()</code> in the return is the current value of the existing key’s timestamp.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'invalid_flag_present'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because an invalid <code class="literal">do_op_flag()</code> was found in the <code class="literal">Flags</code> argument.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'brick_not_available'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the chain that is responsible for this key is currently length zero and therefore unavailable.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{{'nodedown',node()},{'gen_server','call',term()}}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the server brick handling the request has crashed or else a network partition has occurred between the client and server. The client should resend the query after a short delay, on the assumption that the Admin Server will have detected the failure and taken steps to repair the chain.
</li><li class="listitem">
<code class="literal">node() = atom()</code>
</li></ul></div></li></ul></div></dd></dl></div><p>ALIASES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
brick_simple:get/2
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:get(Tab, Key).</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
brick_simple:get/3
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:get(Tab, Key, Flags).</code>
</li><li class="listitem">
<code class="literal">brick_simple:get(Tab, Key, Timeout).</code>
</li></ul></div></li></ul></div></dd></dl></div><p>EXAMPLES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful retrieval of a key-value pair:
</p><pre class="screen">&gt; brick_simple:get(tab1, "goo").
{ok,1271543165272432,&lt;&lt;"value7"&gt;&gt;}</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful retrieval of a key without its associated value blob:
</p><pre class="screen">&gt; brick_simple:get(tab1, "goo", ['witness']).
{ok,1271543165272432}</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Failed attempt to retrieve a key that does not exist:
</p><pre class="screen">&gt; brick_simple:get(tab1, "moo").
key_not_exist</pre></dd></dl></div></div><div class="section" title="3.6.&#xA0;brick_simple:get_many/5"><div class="titlepage"><div><div><h3 class="title"><a id="brick-simple-get-many"></a>3.6. brick_simple:get_many/5</h3></div></div></div><p>SYNOPSIS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd>
<span class="strong"><strong>brick_simple:get_many(Tab, Key, MaxNum, Flags, Timeout).</strong></span>
</dd></dl></div><p>DESCRIPTION</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Get many <code class="literal">Key</code> and <code class="literal">Value</code> pairs from a single chain in the table <code class="literal">Tab</code>, up to a maximum of <code class="literal">MaxNum</code>. Keys are returned in lexicographic sorting order. The key <code class="literal">Key</code> is the starting point: if there is a key <code class="literal">KeyNext</code> that follows <code class="literal">Key</code> (in lexicographic order), and if the <code class="literal">boolean()</code> value in the return is <code class="literal">true</code>, then <code class="literal">KeyNext</code> will be the first key’s info in the <code class="literal">get_many_res_list()</code>.
</p><div class="important" title="Important" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/important.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>The <code class="literal">get_many()</code> function call cannot be used to find all keys in all chains in a Hibari table. The consistent hash of <code class="literal">Key</code> will send the <code class="literal">get_many</code> operation to the tail brick in a single chain; all keys returned will come from that single brick only.</p></td></tr></table></div><p class="simpara">PARAMETERS</p></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Tab</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Name of the table from which to retrieve the keys.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Tab = table()</code>
</li><li class="listitem">
<code class="literal">table() = atom()</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Key</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Key at which to start the <code class="literal">get_many</code> retrieval, proceeding in lexicographic order.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Key = key()</code>
</li><li class="listitem">
<code class="literal">key() = iodata()</code>
</li><li class="listitem">
<code class="literal">iodata() = iolist() | binary()</code>
</li><li class="listitem"><p class="simpara">
<code class="literal">iolist()  = [char() | binary() | iolist()]</code>
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>While the <code class="literal">Key</code> may be specified as either <code class="literal">iolist()</code> or <code class="literal">binary()</code>, it will be converted into binary before operation execution.</p></td></tr></table></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>MaxNum</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Maximum number of keys to return.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">MaxNum = integer()</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Flags</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
List of operational flags to apply to the ‘get_many’ operation, and/or custom property flags.
</li><li class="listitem">
Optional; defaults to empty list.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Flags = flags_list()</code>
</li><li class="listitem">
<code class="literal">flags_list() = [do_op_flag() | property()]</code>
</li><li class="listitem">
<code class="literal">do_op_flag() = 'get_all_attribs' | 'witness' | {'binary_prefix', binary()} | {'max_bytes', integer()}</code>
</li><li class="listitem">
<code class="literal">property() = atom() | {term(), term()}</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
Operational flag usage
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p class="simpara">
<code class="literal">'get_all_attribs'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
Return all attributes of each key. May be used in combination with the <code class="literal">witness</code> flag.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'witness'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
Do not return the value blobs in the result. This flag will guarantee that the brick does not require disk access to satisfy this request.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{'binary_prefix', binary()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
Return only keys that have a
binary prefix that is exactly equal to <code class="literal">binary()</code>.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{'max_bytes', integer()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
Return only as many keys as the sum of the sizes of their corresponding value blobs does not exceed <code class="literal">integer()</code> bytes.
</li></ul></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Timeout</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Operation timeout in milliseconds.
</li><li class="listitem">
Optional; defaults to 15000.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Timeout = timeout()</code>
</li><li class="listitem">
<code class="literal">timeout() = integer() | 'infinity'</code>
</li></ul></div></li></ul></div></dd></dl></div><p>RETURNS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Success returns
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
<code class="literal">{ok, {[{key(), timestamp(), val()}], boolean()}}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
Success return when the <code class="literal">get_many</code> request uses neither the <code class="literal">'witness'</code> flag nor the <code class="literal">'get_all_attribs'</code> flag.
</li><li class="listitem">
<code class="literal">timestamp() = integer()</code>
</li><li class="listitem">
<code class="literal">val() = iodata()</code>
</li><li class="listitem">
<code class="literal">iodata() = iolist() | binary()</code>
</li><li class="listitem">
<code class="literal">iolist()  = [char() | binary() | iolist()]</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{ok, {[{key(), timestamp()}], boolean()}}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
Success return when the <code class="literal">get_many</code> uses <code class="literal">'witness'</code> but not <code class="literal">'get_all_attribs'</code>.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{ok, {[{key(), timestamp(), proplist()}], boolean()}}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
Success return when the <code class="literal">get_many</code> uses both <code class="literal">'witness'</code> and <code class="literal">'get_all_attribs'</code>.
</li><li class="listitem">
<code class="literal">proplist() = [property()]</code>
</li><li class="listitem">
<code class="literal">property() = atom() | {term(), term()}</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{ok, {[{key(), timestamp(), val(), exp_time(), proplist()}], boolean()}}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
Success return when the <code class="literal">get_many</code> uses <code class="literal">'get_all_attribs'</code> but not <code class="literal">'witness'</code>.
</li><li class="listitem"><p class="simpara">
<code class="literal">exp_time() = time_t()</code>
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>When a <code class="literal">proplist()</code> is returned, one of the properties in the list will always be <code class="literal">{val_len,Size::integer()}</code>, where <code class="literal">Size</code> is the size of the value blob in bytes.</p></td></tr></table></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Error returns
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
<code class="literal">'invalid_flag_present'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because an invalid <code class="literal">do_op_flag()</code> was found in the <code class="literal">Flags</code> argument.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'brick_not_available'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the chain that is responsible for this key is currently length zero and therefore unavailable.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{{'nodedown',node()},{'gen_server','call',term()}}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the server brick handling the request has crashed or else a network partition has occurred between the client and server. The client should resend the query after a short delay, on the assumption that the Admin Server will have detected the failure and taken steps to repair the chain.
</li><li class="listitem">
<code class="literal">node() = atom()</code>
</li></ul></div></li></ul></div></dd></dl></div><p>ALIASES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
brick_simple:get_many/3
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:get_many(Tab, Key, MaxNum).</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
brick_simple:get_many/4
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:get_many(Tab, Key, MaxNum, Flags).</code>
</li><li class="listitem">
<code class="literal">brick_simple:get_many(Tab, Key, MaxNum, Timeout).</code>
</li></ul></div></li></ul></div></dd></dl></div><p>EXAMPLES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful retrieval of all keys from a table that currently has only two keys. The boolean <code class="literal">false' indicates that there are no keys following the `foo</code> key:
</p><pre class="screen">&gt; brick_simple:get_many(tab1, "", 5).
{ok,{[{&lt;&lt;"another"&gt;&gt;,1271543102911775,&lt;&lt;"yes!"&gt;&gt;},
      {&lt;&lt;"foo"&gt;&gt;,1271543165272987,&lt;&lt;"Foo again?"&gt;&gt;}],
     false}}</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful retrieval of all keys from a table that currently has only two keys, using the <code class="literal">witness</code> flag in the request.
</p><pre class="screen">&gt; brick_simple:get_many(tab1, "", 5, ['witness']).
{ok,{[{&lt;&lt;"another"&gt;&gt;,1271543102911775},
      {&lt;&lt;"foo"&gt;&gt;,1271543165272987}],
     false}}</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful retrieval of all keys from a table that currently has only two keys, using the <code class="literal">get_all_attribs</code> flag in the request.
</p><pre class="screen">&gt; brick_simple:get_many(tab1, "", 5).
{ok,{[{&lt;&lt;"another"&gt;&gt;,1271543102911775,&lt;&lt;"yes!"&gt;&gt;,0,
       [{val_len,4}]},
      {&lt;&lt;"foo"&gt;&gt;,1271543165272987,&lt;&lt;"Foo again?"&gt;&gt;,0,[{val_len,6}]}],
     false}}</pre></dd></dl></div></div><div class="section" title="3.7.&#xA0;brick_simple:delete/4"><div class="titlepage"><div><div><h3 class="title"><a id="brick-simple-delete"></a>3.7. brick_simple:delete/4</h3></div></div></div><p>SYNOPSIS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd>
<span class="strong"><strong>brick_simple:delete(Tab, Key, Flags, Timeout).</strong></span>
</dd></dl></div><p>DESCRIPTION</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd>
Delete key <code class="literal">Key</code> from the table <code class="literal">Tab</code>.
</dd></dl></div><p>PARAMETERS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Tab</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Name of the table from which to delete the key and its associated value.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Tab = table()</code>
</li><li class="listitem">
<code class="literal">table() = atom()</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Key</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Key to delete from the table.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Key = key()</code>
</li><li class="listitem">
<code class="literal">key() = iodata()</code>
</li><li class="listitem">
<code class="literal">iodata() = iolist() | binary()</code>
</li><li class="listitem"><p class="simpara">
<code class="literal">iolist()  = [char() | binary() | iolist()]</code>
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>While the <code class="literal">Key</code> may be specified as either <code class="literal">iolist()</code> or <code class="literal">binary()</code>, it will be converted into binary before operation execution.</p></td></tr></table></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Flags</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
List of operational flags to apply to the ‘delete’ operation, and/or custom property flags.
</li><li class="listitem">
Optional; defaults to empty list.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Flags = flags_list()</code>
</li><li class="listitem">
<code class="literal">flags_list() = [do_op_flag() | property()]</code>
</li><li class="listitem">
<code class="literal">do_op_flag() = {'testset', timestamp()} |'must_exist' | 'must_not_exist'</code>
</li><li class="listitem">
<code class="literal">timestamp() = integer()</code>
</li><li class="listitem">
<code class="literal">property() = atom() | {term(), term()}</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
Operational flag usage
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p class="simpara">
<code class="literal">{'testset', timestamp()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
Fail the operation if the existing key’s timestamp is not exactly equal to <code class="literal">timestamp()</code>.  If used inside a <a class="ulink" href="#brick-simple-do" target="_top">micro-transaction</a>, abort the transaction if the key’s timestamp is not exactly equal to <code class="literal">timestamp()</code>. Using this flag with <code class="literal">set</code> will result in an error if the key does not already exist or if the key exists but has a non-matching timestamp.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'must_exist'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
For use inside a <a class="ulink" href="#brick-simple-do" target="_top">micro-transaction</a>: abort the transaction if the key does not exist.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'must_not_exist'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
For use inside a <a class="ulink" href="#brick-simple-do" target="_top">micro-transaction</a>: abort the transaction if the key exists.
</li></ul></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Timeout</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Operation timeout in milliseconds.
</li><li class="listitem">
Optional; defaults to 15000.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Timeout = timeout()</code>
</li><li class="listitem">
<code class="literal">timeout() = integer() | 'infinity'</code>
</li></ul></div></li></ul></div></dd></dl></div><p>RETURNS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Success return
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">'ok'</code>
</li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Error returns
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
<code class="literal">'key_not_exist'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the key does not exist.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{'ts_error', timestamp()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the <code class="literal">{'testset', timestamp()}</code> flag was used and there was a timestamp mismatch. The <code class="literal">timestamp()</code> in the return is the current value of the existing key’s timestamp.
</li><li class="listitem">
<code class="literal">timestamp() = integer()</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'invalid_flag_present'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because an invalid <code class="literal">do_op_flag()</code> was found in the <code class="literal">Flags</code> argument.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'brick_not_available'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the chain that is responsible for this key is currently length zero and therefore unavailable.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{{'nodedown',node()},{'gen_server','call',term()}}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the server brick handling the request has crashed or else a network partition has occurred between the client and server. The client should resend the query after a short delay, on the assumption that the Admin Server will have detected the failure and taken steps to repair the chain.
</li><li class="listitem">
<code class="literal">node() = atom()</code>
</li></ul></div></li></ul></div></dd></dl></div><p>ALIASES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
brick_simple:delete/2
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:delete(Tab, Key).</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
brick_simple:delete/3
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:delete(Tab, Key, Flags).</code>
</li><li class="listitem">
<code class="literal">brick_simple:delete(Tab, Key, Timeout).</code>
</li></ul></div></li></ul></div></dd></dl></div><p>EXAMPLES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful deletion of a key and its associated value and attributes:
</p><pre class="screen">&gt; brick_simple:delete(tab1, &lt;&lt;"foo"&gt;&gt;).
ok</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Failed attempt to delete a key that does not exist:
</p><pre class="screen">&gt; brick_simple:delete(tab1, "key6").
key_not_exist</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Failed attempt to delete a key for which we have incorrectly specified its current timestamp:
</p><pre class="screen">&gt; brick_simple:delete(tab1, "goo", [{'testset', 12345}]).
{ts_error,1271543165272987}</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful deletion of a key for which we have correctly specified its current timestamp:
</p><pre class="screen">&gt; brick_simple:delete(tab1, "goo", [{'testset', 1271543165272987}]).
ok</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful deletion of a key, using a non-default operation timeout:
</p><pre class="screen">&gt; brick_simple:delete(tab1, "key3", 30000).
ok</pre></dd></dl></div></div><div class="section" title="3.8.&#xA0;brick_simple:do/4"><div class="titlepage"><div><div><h3 class="title"><a id="brick-simple-do"></a>3.8. brick_simple:do/4</h3></div></div></div><p>SYNOPSIS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd>
<span class="strong"><strong>brick_simple:do(Tab, OpList, OpFlags, Timeout).</strong></span>
</dd></dl></div><p>DESCRIPTION</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Send a list of primitive operations to the table <code class="literal">Tab</code>. They will be executed at the same time by a Hibari brick. If the first item in the <code class="literal">OpList</code> is <code class="literal">brick_server:make_txn()</code> then the list of operations is executed in the context of a micro-transaction: either all operations will be executed successfully or none will be executed. We term these "micro"-transactions because they are subject to certain limitations that apply to all operations that use the <code class="literal">brick_simple:do()</code> API:
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
All impacted keys must be in the same table.
</li><li class="listitem">
All impacted keys must be in the same chain.
</li><li class="listitem">
All operations in the transaction must be sent in a single <code class="literal">brick_simple:do()</code> call. Unlike some other databases, it is not possible to request a transaction handle and to add operations to that transaction in an one-by-one, "ad hoc" manner.
</li></ul></div></dd><dt><span class="term">
 
</span></dt><dd>
For further information about micro-transactions, see <a class="ulink" href="hibari-sysadmin-guide.en.html#micro-transactions" target="_top">Hibari System Administrator’s Guide, "Micro-Transactions" section</a>.
</dd></dl></div><p>PARAMETERS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Tab</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Name of the table in which to perform the operations.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Tab = table()</code>
</li><li class="listitem">
<code class="literal">table() = atom()</code>
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>OpList</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
List of primitive operations to perform. Each primitive is invoked using the <code class="literal">brick_server:make_*()</code> API.
</li><li class="listitem">
Mandatory.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">OpList = do_op_list()</code>
</li><li class="listitem">
<code class="literal">do_op_list() = [do1_op()]</code>
</li><li class="listitem"><p class="simpara">
<code class="literal">do1_op() =</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
<code class="literal">brick_server:make_add(Key, Value, ExpTime, Flags)</code>
</li><li class="listitem">
<code class="literal">brick_server:make_replace(Key, Value, ExpTime, Flags)</code>
</li><li class="listitem">
<code class="literal">brick_server:make_set(Key, Value, ExpTime, Flags)</code>
</li><li class="listitem">
<code class="literal">brick_server:make_get(Key, Flags)</code>
</li><li class="listitem">
<code class="literal">brick_server:make_get_many(Key, Flags)</code>
</li><li class="listitem">
<code class="literal">brick_server:make_delete(Key, Flags)</code>
</li><li class="listitem"><p class="simpara">
<code class="literal">brick_server:make_txn()</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Include <code class="literal">brick_server:make_txn()</code> as the first item in your <code class="literal">OpList</code> if you want the <code class="literal">do</code> operation to be executed as an all-or-nothing transaction.
</li></ul></div></li><li class="listitem">
Note that the arguments for each primitive are the same as those for the primitives when they are executed on their own, with the exclusion of the <code class="literal">Tab</code> and <code class="literal">Timeout</code> arguments, both of which serve as arguments to the overall <code class="literal">do</code> operation rather than as arguments to the primitives. For example, an <code class="literal">add</code> on its own is <code class="literal">brick_simple:add(Tab, Key, Value, ExpTime, Flags, Timeout)</code>, whereas in the context of a <code class="literal">do</code> operation an <code class="literal">add</code> primitive is <code class="literal">brick_server:make_add(Key, Value, ExpTime, Flags)</code>.
</li><li class="listitem">
For further information about each primitive, see <a class="ulink" href="#brick-simple-add" target="_top">brick_simple:add/6</a>, <a class="ulink" href="#brick-simple-replace" target="_top">brick_simple:replace/6</a>, <a class="ulink" href="#brick-simple-set" target="_top">brick_simple:set/6</a>, <a class="ulink" href="#brick-simple-get" target="_top">brick_simple:get/4</a>, <a class="ulink" href="#brick-simple-get-many" target="_top">brick_simple:get_many/5</a>, and <a class="ulink" href="#brick-simple-delete" target="_top">brick_simple:delete/4</a>.
</li></ul></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>OpFlags</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
List of operational flags to apply to the overall ‘do’ operation.
</li><li class="listitem">
Optional; defaults to empty list.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">OpFlags = do_flags_list()</code>
</li><li class="listitem">
<code class="literal">do_flags_list() = [do_flag()]</code>
</li><li class="listitem">
<code class="literal">do_flag() = 'fail_if_wrong_role' | 'ignore_role'</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
Operational flag usage
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem"><p class="simpara">
<code class="literal">'fail_if_wrong_role'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
<span class="emphasis"><em>description to be added</em></span>
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'ignore_role'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
<span class="emphasis"><em>description to be added</em></span>
</li></ul></div></li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
<span class="strong"><strong>Timeout</strong></span>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Operation timeout in milliseconds.
</li><li class="listitem">
Optional; defaults to 15000.
</li><li class="listitem"><p class="simpara">
Type:
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">Timeout = timeout()</code>
</li><li class="listitem">
<code class="literal">timeout() = integer() | 'infinity'</code>
</li></ul></div></li></ul></div></dd></dl></div><p>RETURNS</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Success return
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
<code class="literal">[do1_res_ok]</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
List of <code class="literal">do1_res_ok</code>, one for each primitive operation specified in the <code class="literal">do</code> request. Return list order corresponds to the order in which primitive operations are listed in the request’s <code class="literal">OpList</code>. Note that if the <code class="literal">do</code> request does not use transaction semantics, then some individual primitive operations may fail without the overall <code class="literal">do</code> operation failing.
</li><li class="listitem">
Within the return list, possible <code class="literal">do1_res_ok</code> returns to each individual primitive operation are the same as the possible returns that the primitive operation type could generate if it were executed on its own. For example, within the <code class="literal">do</code> operation’s success return list, the possible returns for a primitive <code class="literal">add</code> operation are the same as the returns described in the <a class="ulink" href="#brick-simple-add" target="_top">brick_simple:add/6</a> section; potential returns to a primitive <code class="literal">replace</code> operation are the same as those described in the <a class="ulink" href="#brick-simple-replace" target="_top">brick_simple:replace/6</a> section; and likewise for <a class="ulink" href="#brick-simple-set" target="_top">set</a>, <a class="ulink" href="#brick-simple-get" target="_top">get</a>, <a class="ulink" href="#brick-simple-get-many" target="_top">get_many</a>, and <a class="ulink" href="#brick-simple-delete" target="_top">delete</a>.
</li></ul></div></li></ul></div></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Error returns
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
<code class="literal">{txn_fail, [{integer(), do1_res_fail()}]}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
Operation failed because transaction semantics were used in the <code class="literal">do</code> request and one or more primitive operations within the transaction failed. The <code class="literal">integer()</code> identifies the failed primitive operation by its position within the request’s <code class="literal">OpList</code>. For example, a 2 indicates that the second primitive listed in the request’s <code class="literal">OpList</code> failed. Note that this position identifier does not count the <code class="literal">txn()</code> specifier at the start of the <code class="literal">OpList</code>.
</li><li class="listitem"><p class="simpara">
<code class="literal">do1_res_fail()</code> indicates the type of failure for the failed primitive operation. Possibilities are:
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem"><p class="simpara">
<code class="literal">{'key_exists', timestamp()}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">timestamp() = integer()</code>
</li></ul></div></li><li class="listitem">
<code class="literal">'key_not_exist'</code>
</li><li class="listitem">
<code class="literal">{'ts_error', timestamp()}</code>
</li><li class="listitem">
<code class="literal">'invalid_flag_present'</code>
</li></ul></div></li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'invalid_flag_present'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because an invalid <code class="literal">do_flag()</code> was found in the <code class="literal">do</code> request’s <code class="literal">OpFlags</code> argument. Note this is a different error than an invalid flag being found within an individual primitive.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">'brick_not_available'</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the chain that is responsible for this key is currently length zero and therefore unavailable.
</li></ul></div></li><li class="listitem"><p class="simpara">
<code class="literal">{{'nodedown',node()},{'gen_server','call',term()}}</code>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
The operation failed because the server brick handling the request has crashed or else a network partition has occurred between the client and server. The client should resend the query after a short delay, on the assumption that the Admin Server will have detected the failure and taken steps to repair the chain.
</li><li class="listitem">
<code class="literal">node() = atom()</code>
</li></ul></div></li></ul></div></dd></dl></div><p>ALIASES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
brick_simple:do/2
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:do(Tab, OpList).</code>
</li></ul></div></li><li class="listitem"><p class="simpara">
brick_simple:do/3
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<code class="literal">brick_simple:do(Tab, OpList, Timeout).</code>
</li></ul></div></li></ul></div></dd></dl></div><p>EXAMPLES</p><div class="variablelist"><dl><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful <code class="literal">do</code> operation adding two new keys to table <code class="literal">tab1</code>, without transaction semantics:
</p><pre class="screen">&gt; brick_simple:do(tab1, [brick_server:make_add("foo3", "bar3"),brick_server:make_add("foo4", "bar4")]).
[ok,ok]</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Successful creation of two <code class="literal">get</code> primitives <code class="literal">Do1</code> and <code class="literal">Do2</code>, and their subsequent combination into a <code class="literal">do</code> request, without transaction semantics:
</p><pre class="screen">&gt; Do1 = brick_server:make_get("foo").
{get,&lt;&lt;"foo"&gt;&gt;,[]}
&gt; Do2 = brick_server:make_get("foo2").
{get,&lt;&lt;"foo2"&gt;&gt;,[]}
&gt; brick_simple:do(tab1, [Do1, Do2]).
[{ok,1271543102911775,&lt;&lt;"Foo again?"&gt;&gt;},key_not_exist]</pre></dd><dt><span class="term">
 
</span></dt><dd><p class="simpara">
Failed operation with transaction semantics. Because transaction semantics are used, the failure of the primitive <code class="literal">Do2b</code> causes the entire operation to fail.
</p><pre class="screen">&gt; Do1b = brick_server:make_get("foo").
{get,&lt;&lt;"foo"&gt;&gt;,[]}
&gt; Do2b = brick_server:make_get("foo2", [must_exist]).
{get,&lt;&lt;"foo2"&gt;&gt;,[must_exist]}
&gt; brick_simple:do(tab1, [brick_server:make_txn(), Do1b, Do2b]).
{txn_fail,[{2,key_not_exist}]}</pre></dd></dl></div></div></div><div class="section" title="4.&#xA0;Client API: UBF"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="client-api-ubf"></a>4. Client API: UBF</h2></div></div></div><p><a class="ulink" href="http://github.com/norton/ubf" target="_top">The UBF protocol</a> is a
formally-specified family of protocols that are supported by a large
number of client languages.  This section attempts to describe the
layers of the UBF protocol stack, how to use the UBF client in Erlang
and other languages, and how to use that client to access a Hibari
storage cluster.</p><p>The Hibari source distribution includes UBF/EBF protocol support for the
following languages:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Erlang, see <a class="xref" href="#using-ubf-erlang-client" title="4.5.&#xA0;Using the UBF Client Library for Erlang">Section 4.5, “Using the UBF Client Library for Erlang”</a>
</li><li class="listitem">
Java, see <a class="xref" href="#using-ubf-java-client" title="4.6.&#xA0;Using the UBF Client Library for Java">Section 4.6, “Using the UBF Client Library for Java”</a>
</li><li class="listitem">
Python, see <a class="xref" href="#using-ubf-python-client" title="4.7.&#xA0;Using the EBF Client Library for Python">Section 4.7, “Using the EBF Client Library for Python”</a>
</li></ul></div><div class="section" title="4.1.&#xA0;The Hibari Server&#x2019;s Implementation of the UBF Protocol Stack"><div class="titlepage"><div><div><h3 class="title"><a id="hibari-server-impl-of-ubf-proto-stack"></a>4.1. The Hibari Server’s Implementation of the UBF Protocol Stack</h3></div></div></div><div class="variablelist"><dl><dt><span class="term">
UBF(A): Bottom Layer, transport and session protocol layer
</span></dt><dd><p class="simpara">
This layer plays the same basic role as many other serialized data
transport protocols that use TCP for host-to-host transport, such as
<a class="ulink" href="http://en.wikipedia.org/wiki/Open_Network_Computing_Remote_Procedure_Call" target="_top">ONC-RPC</a>,
<a class="ulink" href="http://en.wikipedia.org/wiki/IIOP" target="_top">CORBA IIOP</a>,
<a class="ulink" href="http://en.wikipedia.org/wiki/Protocol_buffers" target="_top">Protocol Buffers</a>,
and
<a class="ulink" href="http://en.wikipedia.org/wiki/Thrift_(protocol)" target="_top">Thrift</a>.
</p><p class="simpara">Hibari servers support several of these session protocols on top
of a TCP/IP transport protocol.  The choice of session protocol is
a matter of convenience and/or support for the application
developer. Hibari should be as easy for an app developer to use
Ruby and JSON-RPC as it is to use Python and Protocol Buffers.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
UBF(A), Joe Armstrong’s original session layer protocol
</li><li class="listitem">
EBF, the Erlang Binary Format.  The session layer protocol is a
  thin, efficient that uses the Erlang BIFs <code class="literal">term_to_binary()</code> and
  <code class="literal">binary_to_term()</code> to serialize Erlang data terms.  This protocol
  is very closely related to the <a class="ulink" href="http://bert-rpc.org/" target="_top">BERT protocol</a>.
</li><li class="listitem">
JSON over TCP, also called JSF (the JavaScript
  Format).  Erlang terms are encoded as
  <a class="ulink" href="http://en.wikipedia.org/wiki/JSON" target="_top">JSON terms</a>
  and transmitted directly over a TCP transport.  This
  protocol is not in common use but is easy to implement in the UBF
  server framework.
</li><li class="listitem">
HTTP, the <a class="ulink" href="http://en.wikipedia.org/wiki/HTTP" target="_top">Hypertext
  Transfer Protocol</a>.  This protocol is used to support Hibari’s
  <a class="ulink" href="http://en.wikipedia.org/wiki/JSON-RPC" target="_top">JSON-RPC</a> server.
</li><li class="listitem">
<a class="ulink" href="http://en.wikipedia.org/wiki/Thrift_(protocol)" target="_top">Thrift</a>.
  Similar to EBF, except that Thrift’s binary encoding is used for
  the wire protocol instead of UBF(A) or Erlang’s native wire
  formats.
  <span class="strong"><strong>Hibari support is experimental (i.e. not yet implemented).</strong></span>
</li><li class="listitem">
<a class="ulink" href="http://en.wikipedia.org/wiki/Protocol_buffers" target="_top">Protocol Buffers</a>.
  Similar to EBF, except that Google’s Protocol Buffers binary
  encoding is used for the wire protocol instead of UBF(A) or
  Erlang’s native wire formats.
  <span class="strong"><strong>Hibari support is experimental (i.e. not yet implemented).</strong></span>
</li><li class="listitem">
<a class="ulink" href="http://hadoop.apache.org/avro/docs/current/" target="_top">Avro</a>.
  Similar to EBF, except that Avro’s binary encoding is used for the
  wire protocol instead of UBF(A) or Erlang’s native wire formats.
  <span class="strong"><strong>Hibari support is experimental (i.e. not yet implemented).</strong></span>
</li></ul></div></dd><dt><span class="term">
UBF(B): Middle Layer, the "contract"
</span></dt><dd><p class="simpara">
UBF(B) is a programming language for describing types in UBF(A)
and protocols between clients and servers. UBF(B) is roughly
equivalent to to Verified XML, XML-schemas, SOAP and WDSL.
</p><p class="simpara">This layer enforces a protocol "contract", a formal specification of
all data sent by the client and by the server.  Any data that does not
precisely conform to the protocol is rejected by the contract checker
(which is embedded in the server).  If the client wishes, it may also
use the contract checker to validate data sent by the server, though
this not commonly done.</p></dd><dt><span class="term">
UBF( C): Top Layer, the UBF Metaprotocol
</span></dt><dd>
The metaprotocol is used at the beginning of a UBF session to select
one of the UBF(B) contracts that the TCP listener is capable of
offering.  At the moment, Hibari servers support only the "gdss"
contract, but other contracts may be added in the future.
</dd></dl></div></div><div class="section" title="4.2.&#xA0;UBF representation of strings vs. binaries"><div class="titlepage"><div><div><h3 class="title"><a id="ubf-representation-of-strings"></a>4.2. UBF representation of strings vs. binaries</h3></div></div></div><p>The Erlang language does not have a data type specifically for
strings.  Instead, strings are typically represented as lists of
integers (ASCII byte values) and/or binaries.</p><p>A UBF contract makes a distinction between a string, list, and
binary.  In the case of a string, UBF(A) encodes a string using the
notation <code class="literal">{'#S', "Hello, world!"}</code> to represent the string "Hello,
world!".</p><p>This string encoding is cumbersome to use for developers; in Erlang,
the <code class="literal">ubf.hrl</code> header file includes a macro <code class="literal">?S("Hello, world!")</code> as a
slightly less ugly shortcut.  When using other languages, the 2-tuple
and the atom <code class="literal">'#S'</code>  would be created as any other 2-tuple and atom.</p><p>Fortunately, there is only one case where the string type is
necessary: using the <code class="literal">startSession</code> metaprotocol command to start
using the Hibari data server contract.  An example will be shown
below.</p></div><div class="section" title="4.3.&#xA0;Steps for Using a UBF-based Protocol in Any Language"><div class="titlepage"><div><div><h3 class="title"><a id="using-ubf-in-any-language"></a>4.3. Steps for Using a UBF-based Protocol in Any Language</h3></div></div></div><p>The steps to use a UBF-based protocol are the same in any language.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Create a connection to the UBF server.
</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
… or the EBF server, or the JSON-RPC server, or the Thrift
server, or the ….
</li></ul></div></li><li class="listitem">
Use the UBF metaprotocol to start using the <code class="literal">gdss</code> contract,
   i.e. the Hibari server contract.
</li><li class="listitem">
Send one or more Hibari server queries and decode the respective
   server responses.
</li><li class="listitem">
Close the connection to the UBF server.
</li></ol></div></div><div class="section" title="4.4.&#xA0;The Hibari UBF Protocol Contract"><div class="titlepage"><div><div><h3 class="title"><a id="the-hibari-ubf-protocol-contract"></a>4.4. The Hibari UBF Protocol Contract</h3></div></div></div><p>The Hibari UBF Protocol contract can be found in the file
<code class="literal">ubf_gdss_plugin.con</code>.</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>See the Hibari source code for the most up-to-date version of
this file.  <a class="ulink" href="./misc-codes/ubf_gdss_plugin.con" target="_top">This documentation has a copy
of <code class="literal">ubf_gdss_plugin.con</code></a>, though it may be slightly out-of-date.</p></td></tr></table></div><p>The names of the UBF types specified in the contract may differ
slightly from the names of the types used in this document’s
<a class="xref" href="#client-api-erlang" title="3.&#xA0;Client API: Native Erlang">Section 3, “Client API: Native Erlang”</a>.  For example, the UBF contract calls the key
expiration time time <code class="literal">exp_time()</code>, while the type system in this
document calls it <code class="literal">expiry()</code>.  However, in all cases of slightly
different names, the fundamental data type that both names use is the
same: e.g. <code class="literal">integer()</code> for expiration time.</p><p>For each command, the UBF contract uses the following naming
conventions:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">CommandName_req()</code> for the request sent from client → server,
  e.g. <code class="literal">set_req()</code> for the <code class="literal">set</code> command.
</li><li class="listitem">
<code class="literal">CommandName_res()</code> for the response sent from server → client,
  e.g. <code class="literal">set_res()</code> for the <code class="literal">set</code> response.
</li></ul></div><p>The general form of a UBF RPC call is a tuple.  The first element in
the tuple is the name of the command, and the following elements are
arguments for that command.  The response can be any Erlang term, but
the Hibari contract will only return the atom or tuple types.</p><p>The following is a mapping of UBF client request type to its Erlang
API function, in alphabetical order.:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
<code class="literal">add_req()</code> → <code class="literal">brick_simple:add()</code>, see <a class="xref" href="#brick-simple-add" title="3.2.&#xA0;brick_simple:add/6">Section 3.2, “brick_simple:add/6”</a>.
</li><li class="listitem">
<code class="literal">delete_req()</code> → <code class="literal">brick_simple:delete()</code>, see <a class="xref" href="#brick-simple-delete" title="3.7.&#xA0;brick_simple:delete/4">Section 3.7, “brick_simple:delete/4”</a>.
</li><li class="listitem">
<code class="literal">do_req()</code> → <code class="literal">brick_simple:do()</code>, see <a class="xref" href="#brick-simple-do" title="3.8.&#xA0;brick_simple:do/4">Section 3.8, “brick_simple:do/4”</a>.
</li><li class="listitem">
<code class="literal">get_req()</code> → <code class="literal">brick_simple:get()</code>, see <a class="xref" href="#brick-simple-get" title="3.5.&#xA0;brick_simple:get/4">Section 3.5, “brick_simple:get/4”</a>.
</li><li class="listitem">
<code class="literal">get_many_req()</code> → <code class="literal">brick_simple:get_many()</code>, see <a class="xref" href="#brick-simple-get-many" title="3.6.&#xA0;brick_simple:get_many/5">Section 3.6, “brick_simple:get_many/5”</a>.
</li><li class="listitem">
<code class="literal">replace_req()</code> → <code class="literal">brick_simple:replace()</code>, see <a class="xref" href="#brick-simple-replace" title="3.3.&#xA0;brick_simple:replace/6">Section 3.3, “brick_simple:replace/6”</a>.
</li><li class="listitem">
<code class="literal">set_req()</code> → <code class="literal">brick_simple:set()</code>, see <a class="xref" href="#brick-simple-set" title="3.4.&#xA0;brick_simple:set/6">Section 3.4, “brick_simple:set/6”</a>.
</li></ul></div></div><div class="section" title="4.5.&#xA0;Using the UBF Client Library for Erlang"><div class="titlepage"><div><div><h3 class="title"><a id="using-ubf-erlang-client"></a>4.5. Using the UBF Client Library for Erlang</h3></div></div></div><div class="important" title="Important" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/important.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
When using the Erlang shell for experimentation &amp; prototyping, that
   shell must have the path to the Erlang UBF client
   library in its search path.  The easiest way to do this is to use
   the arguments <code class="literal">-pz /path/to/ubf/library/ebin</code> to your Erlang
   shell’s <code class="literal">erl</code> command.
</li><li class="listitem">
When writing code, the statement <code class="literal">-include("ubf.hrl").</code> at the top
   of your source module to gain access to the <code class="literal">?S()</code> macro.  Due to
   limitations in the Erlang shell, macros cannot be used in the shell.
</li></ol></div></td></tr></table></div><p>As outlined in <a class="xref" href="#using-ubf-in-any-language" title="4.3.&#xA0;Steps for Using a UBF-based Protocol in Any Language">Section 4.3, “Steps for Using a UBF-based Protocol in Any Language”</a>, the first step is to
create a connection to a Hibari server.  If the Hibari cluster has
multiple nodes, then it doesn’t matter which one that you connect to:
all nodes can handle any UBF request and will route the query to the
proper brick.</p><p title="Create a connection to the UBF server (on &quot;localhost&quot; TCP port 7581)"><b>Create a connection to the UBF server (on "localhost" TCP port 7581). </b>
</p><pre class="screen">(asdf@bb3)54&gt; {ok, P1, _} = ubf_client:connect("localhost", 7581, [{proto, ubf}], 5000).
{ok,&lt;0.139.0&gt;,{'#S', "gdss_meta_server"}}</pre><p title="Create a connection to the UBF server (on &quot;localhost&quot; TCP port 7581)">
</p><p>The second step is to use the UBF metaprotocol to select the Hibari
server, contract, called "gdss",
for all further commands for this connection.</p><div class="tip" title="Tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/tip.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>The Hibari server contract is "stateless".  All replies terms from the
<code class="literal">ubf_client:rpc/2</code> function use the form
<code class="literal">{reply,ServerReply,UBF_StateName}</code>.  Because the Hibari server
contract is stateless, the <code class="literal">UBF_StateName</code> will always be the atom
<code class="literal">none</code>.</p></td></tr></table></div><p title="Use the UBF metaprotocol to request the &quot;gdss&quot; contract"><b>Use the UBF metaprotocol to request the "gdss" contract. </b>
</p><pre class="screen">(asdf@bb3)55&gt; ubf_client:rpc(P1, {startSession, {'#S', "gdss"}, []}).
{reply,{ok,ok},none}</pre><p title="Use the UBF metaprotocol to request the &quot;gdss&quot; contract">
</p><p>Now that the UBF connection is set up, we can use it to set a key "foo".</p><p title="Set the key &quot;foo&quot; in table tab1 with the value &quot;foo val&quot;, no expiration time, no flags, and a timeout of 5 seconds"><b>Set the key "foo" in table <code class="literal">tab1</code> with the value "foo val", no expiration time, no flags, and a timeout of 5 seconds. </b>
</p><pre class="screen">(asdf@bb3)59&gt; ubf_client:rpc(P1, {set, tab1, &lt;&lt;"foo"&gt;&gt;, &lt;&lt;"foo val"&gt;&gt;, 0, [], 5000}).
{reply,ok,none}</pre><p title="Set the key &quot;foo&quot; in table tab1 with the value &quot;foo val&quot;, no expiration time, no flags, and a timeout of 5 seconds">
</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Note that the return value of both the
<code class="literal">set_req()</code> (in the example above) and <code class="literal">get_req()</code> (in the example
below) return the same types described in the <a class="xref" href="#brick-simple-set" title="3.4.&#xA0;brick_simple:set/6">Section 3.4, “brick_simple:set/6”</a>
and <a class="xref" href="#brick-simple-get" title="3.5.&#xA0;brick_simple:get/4">Section 3.5, “brick_simple:get/4”</a>, respectively.</p><p>The only difference is that the <code class="literal">ubf_client:rpc/2</code> function wraps the
server’s reply in a 3-tuple: <code class="literal">{reply,ServerReply,none}</code>.</p></td></tr></table></div><p title="Get the key &quot;foo&quot; in table tab1, timeout in 5 seconds"><b>Get the key "foo" in table <code class="literal">tab1</code>, timeout in 5 seconds. </b>
</p><pre class="screen">(asdf@bb3)66&gt; ubf_client:rpc(P1, {get, tab1, &lt;&lt;"foo"&gt;&gt;, [], 5000}).
{reply,{ok,1273009092549799,&lt;&lt;"foo val"&gt;&gt;},none}</pre><p title="Get the key &quot;foo&quot; in table tab1, timeout in 5 seconds">
</p><p>If the client sends a request that violates the contract, the server
will tell you, as in this example:</p><p title="Send a contract-violating request"><b>Send a contract-violating request. </b>
</p><pre class="screen">(asdf@bb3)89&gt; ubf_client:rpc(P1, {bbb, 3000}).
{reply,{clientBrokeContract,{bbb,3000},[]},none}</pre><p title="Send a contract-violating request">
</p><p>When you are done with the connection, it is polite to close the
connection explicitly.  The server will quietly clean up its side of
the connection if the client forgets to call or cannot call <code class="literal">stop/1</code>.</p><p title="Close the UBF connection"><b>Close the UBF connection. </b>
</p><pre class="screen">(asdf@bb3)92&gt; ubf_client:stop(P1).
ok</pre><p title="Close the UBF connection">
</p></div><div class="section" title="4.6.&#xA0;Using the UBF Client Library for Java"><div class="titlepage"><div><div><h3 class="title"><a id="using-ubf-java-client"></a>4.6. Using the UBF Client Library for Java</h3></div></div></div><p>The source code for the UBF client library for Java is included in
the UBF source repository at
<a class="ulink" href="http://github.com/norton/ubf" target="_top">http://github.com/norton/ubf</a>, in
the <code class="literal">priv/java</code> subdirectory.</p><div class="section" title="Compiling the UBF client library for Java"><div class="titlepage"><div><div><h4 class="title"><a id="_compiling_the_ubf_client_library_for_java"></a>Compiling the UBF client library for Java</h4></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Please update your UBF client library code to the "master" branch
   for a date after 10 May 2010, or use the Git tag "v1.14" or later.
   Versions of the library before 10 May 2010 and tag "v1.14" have
   several bugs that will prevent the UBF client from working
   correctly.
</li><li class="listitem">
Change directory to the <code class="literal">priv/java</code> directory of the UBF client
   library source distribution.
</li><li class="listitem">
Run <code class="literal">make</code>.
</li><li class="listitem">
(Optional) Copy the class files in the <code class="literal">classes</code> subdirectory to
   a suitable directory for your Java development environment.
</li></ol></div></div><div class="section" title="Compiling the UBF client library test program HibariTest.java"><div class="titlepage"><div><div><h4 class="title"><a id="_compiling_the_ubf_client_library_test_program_hibaritest_java"></a>Compiling the UBF client library test program HibariTest.java</h4></div></div></div><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Change directory to the <code class="literal">gdss-ubf-proto/priv/java</code> subdirectory in
   the Hibari source distribution.
</li><li class="listitem">
Edit the <code class="literal">Makefile</code> to change the <code class="literal">UBF_CLASSES_DIR</code> variable to
   point to the <code class="literal">priv/java/classes</code> subdirectory of the UBF package’s
   source code (or the subdirectory where those classes have been
   formally installed on your system).
</li><li class="listitem"><p class="simpara">
Run the following two <code class="literal">make</code> commands.  The second assumes that the
   Hibari server’s UBF server is on the local machine, "localhost".
</p><pre class="screen">% make HibariTest
% make run-HibariTest</pre></li><li class="listitem">
If the Hibari server is not running on the local machine, then run
   <code class="literal">make -n run-HibariTest</code> to show the <code class="literal">java</code> command that is used to
   run the test program.  Cut-and-paste the command into your shell,
   then edit the last argument to specify the hostname of a Hibari
   server.
</li></ol></div></div><div class="section" title="Examining the HibariTest.java test program"><div class="titlepage"><div><div><h4 class="title"><a id="_examining_the_hibaritest_java_test_program"></a>Examining the HibariTest.java test program</h4></div></div></div><p>The <code class="literal">main()</code> function does three things:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Create a new UBF connection to a Hibari server (hostname/IP address
   is specified in the first command line argument) and requests the
   <code class="literal">gdss</code> contract via the UBF metaprotocol.
</li><li class="listitem">
Run the small test cases in the <code class="literal">test_hibari_basics()</code> method.
</li><li class="listitem">
Close the UBF session and exit.
</li></ol></div><p title="The ubf.HibariTest.main() method"><a id="the-ubf-hibaritest-main-method"></a><b>The ubf.HibariTest.main() method. </b>
</p><pre class="screen">public class HibariTest
{
    public static void main(String[] args)
        throws Exception
    {
        Socket sock = null;
        UBFClient ubf = null;

        try {
            sock = new Socket(args[0], 7581);
            ubf = UBFClient.new_via_sock(new UBFString("gdss"), new UBFList(),
                    new FooHandler(), sock);
        }
        catch (Exception e) {
            System.out.println(e);
            System.exit(1);
        }

        test_hibari_basics(ubf);

        ubf.stopSession();
        System.out.println("Success, it works");
        System.exit(0);
    }
/* ... */
}</pre><p title="The ubf.HibariTest.main() method">
</p><p>The <code class="literal">test_hibari_basics()</code> method performs the same basic UBF
operations as the Python EBF demonstration script described in
<a class="xref" href="#using-ubf-python-client" title="4.7.&#xA0;Using the EBF Client Library for Python">Section 4.7, “Using the EBF Client Library for Python”</a>.  Unlike the Python demo script, the
demo program does not use the Hibari <code class="literal">do()</code> command but rather then
single-operation commands like <code class="literal">get()</code> and <code class="literal">set()</code>.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Delete the key <code class="literal">foo</code> from table <code class="literal">tab1</code>.
</p><pre class="screen">    public static void test_hibari_basics(UBFClient ubf)
        throws IOException, UBFException
    {
        // setup
        UBFObject res1 = ubf.rpc(
                UBF.tuple( new UBFAtom("delete"), new UBFAtom("tab1"),
                            new UBFBinary("foo"), new UBFList(),
                            new UBFInteger(4000)));
        System.out.println("Res 1:" + res1.toString());</pre></li><li class="listitem"><p class="simpara">
Add the key <code class="literal">foo</code> to table <code class="literal">tab1</code>.
</p><pre class="screen">        // add - ok
        UBFObject res2 = ubf.rpc(
                UBF.tuple( new UBFAtom("add"), atom_tab1,
                            new UBFBinary("foo"), new UBFBinary("bar"),
                            new UBFInteger(0), new UBFList(),
                            new UBFInteger(4000)));
        System.out.println("Res 2:" + res2.toString());
        if (! res2.equals(atom_ok))
            System.exit(1);</pre></li><li class="listitem"><p class="simpara">
Add the key <code class="literal">foo</code> to table <code class="literal">tab1</code> again, this time expecting a
failure.
</p><pre class="screen">        // add - ng
        UBFObject res3 = ubf.rpc(
                UBF.tuple( new UBFAtom("add"), atom_tab1,
                            new UBFBinary("foo"), new UBFBinary("bar"),
                            new UBFInteger(0), new UBFList(),
                            new UBFInteger(4000)));
        System.out.println("Res 3:" + res3.toString());
        if (! ((UBFTuple)res3).value[0].equals(atom_key_exists))
            System.exit(1);</pre></li><li class="listitem"><p class="simpara">
Get the key <code class="literal">foo</code> from table <code class="literal">tab1</code>.
</p><pre class="screen">        // get - ok
        UBFObject res4 = ubf.rpc(
                UBF.tuple( new UBFAtom("get"), atom_tab1,
                            new UBFBinary("foo"), new UBFList(),
                            new UBFInteger(4000)));
        System.out.println("Res 4:" + res4.toString());
        if (! ((UBFTuple)res4).value[0].equals(atom_ok) ||
            ! ((UBFTuple)res4).value[2].equals("bar"))
            System.exit(1);</pre></li><li class="listitem"><p class="simpara">
Set the key <code class="literal">foo</code> in table <code class="literal">tab1</code> to <code class="literal">bar bar</code>.
</p><pre class="screen">        // set - ok
        UBFObject res5 = ubf.rpc(
                UBF.tuple( new UBFAtom("set"), atom_tab1,
                            new UBFBinary("foo"), new UBFBinary("bar bar"),
                            new UBFInteger(0), new UBFList(),
                            new UBFInteger(4000)));
        System.out.println("Res 5:" + res5.toString());
        if (! res5.equals(atom_ok))
            System.exit(1);</pre></li><li class="listitem"><p class="simpara">
Get <code class="literal">foo</code> again and verify that the value is <code class="literal">bar bar</code>
</p><pre class="screen">        // get - ok
        UBFObject res6 = ubf.rpc(
                UBF.tuple( new UBFAtom("get"), atom_tab1,
                            new UBFBinary("foo"), new UBFList(),
                            new UBFInteger(4000)));
        System.out.println("Res 6:" + res6.toString());
        if (! ((UBFTuple)res6).value[0].equals(atom_ok) ||
            ! ((UBFTuple)res6).value[2].equals("bar bar"))
            System.exit(1);</pre></li></ol></div></div><div class="section" title="The UBF event handler interface"><div class="titlepage"><div><div><h4 class="title"><a id="_the_ubf_event_handler_interface"></a>The UBF event handler interface</h4></div></div></div><p>Each <code class="literal">UBFClient</code> instance uses a separate thread to read data from the
server and do any of the following:</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem">
Signal to the other thread that a synchronous RPC response was
received from the server.
</li><li class="listitem">
Run a callback function when an <code class="literal">event_out</code> asynchronous event is
received from the server.
</li><li class="listitem">
The socket was closed unexpectedly.
</li></ol></div><p>In cases #2 and #3, a class that implements the <code class="literal">UBFEventHandler</code>
interface is used to define the action to be taken in those cases.</p><p>The <code class="literal">HibariTest.java</code> contains a sample implementation of callback
functions for asynchronous events.  A real application would probably
want to do something much more helpful than this example does.</p><pre class="screen">    public static class FooHandler implements UBFEventHandler {
        public FooHandler() {
        }
        public void handleEvent(UBFClient client, UBFObject event) {
            System.out.println("Hey, got an event: " + event.toString());
        }
        public void connectionClosed(UBFClient client) {
            System.out.println("Hey, connection closed, ignoring it\n");
        }
    }</pre><div class="tip" title="Tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/tip.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>See <a class="xref" href="#the-ubf-hibaritest-main-method" title="The ubf.HibariTest.main() method">The ubf.HibariTest.main() method</a> for an example that
uses this <code class="literal">FooHandler</code> class.</p></td></tr></table></div></div></div><div class="section" title="4.7.&#xA0;Using the EBF Client Library for Python"><div class="titlepage"><div><div><h3 class="title"><a id="using-ubf-python-client"></a>4.7. Using the EBF Client Library for Python</h3></div></div></div><p>The source code for the EBF client library for Python is included in
the UBF source repository at
<a class="ulink" href="http://github.com/norton/ubf" target="_top">http://github.com/norton/ubf</a>, in
the <code class="literal">priv/python</code> subdirectory.</p><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Recall that the EBF protocol is very closely related to UBF.  The
only significant difference is the "layer 5" session protocol layer:
instead of using the UBF(A) protocol, the EBF (Erlang Binary Format)
protocol is used instead.  See
<a class="xref" href="#hibari-server-impl-of-ubf-proto-stack" title="4.1.&#xA0;The Hibari Server&#x2019;s Implementation of the UBF Protocol Stack">Section 4.1, “The Hibari Server’s Implementation of the UBF Protocol Stack”</a> for more details.</p></td></tr></table></div><p>In addition, you will need the "py_interface" package, developed by
Tomas Abrahamsson and others.  "py-interface" is distributed under the
<a class="ulink" href="http://www.fsf.org/licensing/education/licenses/lgpl.html" target="_top">GNU
Library General Public License</a>.  A git repository is hosted at
repo.or.cz. To clone it and build it, use:</p><pre class="screen">git clone git://repo.or.cz/py_interface.git
cd py_interface
autoconf
./configure
make
pwd</pre><p>Use the output of the last command, <code class="literal">pwd</code>, to remember the full
directory path to the "py-interface" library.  The example below
assumes that path is <code class="literal">/tmp/py-interface</code>.</p><p>The <code class="literal">pyebf.py</code> file contains a small unit test that makes several
calls to the Hibari UBF contract’s <code class="literal">do_req()</code> command.  The results of
(almost) every command are verified using the <code class="literal">assert</code> function.</p><pre class="screen">env PYTHONPATH=/path/to/py_interface python pyebf.py</pre><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Connect to the Hibari server on "localhost" TCP port 7580 and use
the UBF metaprotocol to switch to the <code class="literal">gdss</code> contract.
</p><pre class="screen">    ## login
    ebf.login('gdss', 'gdss_meta_server')</pre></li><li class="listitem"><p class="simpara">
Delete the key <code class="literal">'foo'</code> from table <code class="literal">tab1</code>.
</p><pre class="screen">    ## setup
    req0 = (Atom('do'), Atom('tab1'), [(Atom('delete'), 'foo', [])], [], 1000)
    res0 = ebf.rpc('gdss', req0)</pre></li><li class="listitem"><p class="simpara">
Get the key <code class="literal">'foo'</code> from table <code class="literal">tab1</code>.
</p><pre class="screen">    ## get - ng
    req1 = (Atom('do'), Atom('tab1'), [(Atom('get'), 'foo', [])], [], 1000)
    res1 = ebf.rpc('gdss', req1)
    assert res1[0] == 'key_not_exist'</pre></li><li class="listitem"><p class="simpara">
Add the key <code class="literal">'foo'</code> to table <code class="literal">tab1</code>.  The <code class="literal">do_req()</code> interface
requires managing the timestamp integers explicitly by the client; the
timestamp <code class="literal">1</code> is used here.
</p><pre class="screen">    ## add - ok
    req2 = (Atom('do'), Atom('tab1'), [(Atom('add'), 'foo', 1, 'bar', 0, [])], [
], 1000)
    res2 = ebf.rpc('gdss', req2)
    assert res2[0] == 'ok'</pre></li><li class="listitem"><p class="simpara">
Add the key <code class="literal">'foo'</code> to table <code class="literal">tab1</code>.
</p><pre class="screen">    ## add - ng
    req3 = (Atom('do'), Atom('tab1'), [(Atom('add'), 'foo', 1, 'bar', 0, [])], [
], 1000)
    res3 = ebf.rpc('gdss', req3)
    assert res3[0][0] == 'key_exists'
    assert res3[0][1] == 1</pre></li><li class="listitem"><p class="simpara">
Get the key <code class="literal">'foo'</code> from table <code class="literal">tab1</code>, verifying that the timestamp
is still <code class="literal">1</code> and value is still <code class="literal">'bar'</code>.
</p><pre class="screen">    ## get - ok
    req4 = (Atom('do'), Atom('tab1'), [(Atom('get'), 'foo', [])], [], 1000)
    res4 = ebf.rpc('gdss', req4)
    assert res4[0][0] == 'ok'
    assert res4[0][1] == 1
    assert res4[0][2] == 'bar'</pre></li><li class="listitem"><p class="simpara">
Set the key <code class="literal">'foo'</code> from table <code class="literal">tab1</code>, using a new timestamp <code class="literal">2</code>.
</p><pre class="screen">    ## set - ok
    req5 = (Atom('do'), Atom('tab1'), [(Atom('set'), 'foo', 2, 'baz', 0, [])], [
], 1000)
    res5 = ebf.rpc('gdss', req5)
    assert res5[0] == 'ok'</pre></li><li class="listitem"><p class="simpara">
Get the key <code class="literal">'foo'</code> from table <code class="literal">tab1</code>, verifying both the new
timestamp and new value.
</p><pre class="screen">    ## get - ok
    req6 = (Atom('do'), Atom('tab1'), [(Atom('get'), 'foo', [])], [], 1000)
    res6 = ebf.rpc('gdss', req6)
    assert res6[0][0] == 'ok'
    assert res6[0][1] == 2
    assert res6[0][2] == 'baz'</pre></li></ol></div></div></div><div class="section" title="5.&#xA0;Client API: Thrift"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="client-api-tbf"></a>5. Client API: Thrift</h2></div></div></div><p>"TBF" is a <a class="ulink" href="https://github.com/apache/thrift" target="_top">Thrift
protocol</a> defined by UBF contract
<a class="xref" href="#the-hibari-ubf-protocol-contract" title="4.4.&#xA0;The Hibari UBF Protocol Contract">Section 4.4, “The Hibari UBF Protocol Contract”</a>.  This section attempts to
describe the Hibari Thrift API which allows users to access Hibari with
Thrift clients in any Thrift supported programming languages, and how
to extend the API for application uses.</p><div class="section" title="5.1.&#xA0;The Hibari Thrift API"><div class="titlepage"><div><div><h3 class="title"><a id="_the_hibari_thrift_api"></a>5.1. The Hibari Thrift API</h3></div></div></div><p>The Hibari Thrift API is defined as Hibari Service in
<a class="ulink" href="./misc-codes/hibari.thrift" target="_top">hibari.thrift</a>.  At the time this API
was developed, only Thrift 0.4.0 is available to us.  This version is
our first attempt to adopt Thrift.  Some of the functions and options
are not yet supported.</p><div class="important" title="Important" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Important"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Important]" src="images/icons/important.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>The Hibari Thrift API only supports Thrift 0.4.0 or above.</p></td></tr></table></div><pre class="screen">service Hibari {

  /**
   * Check connection availability / keepalive
   */
  oneway void keepalive()

  /**
   * Hibari Server Info
   */
  string info()

  /**
   * Hibari Description
   */
  string description()

  /**
   * Hibari Contract
   */
  string contract()

  /**
   * Add
   */
  HibariResponse Add(1: Add request)
      throws (1:HibariException ouch)

  /**
   * Replace
   */
  HibariResponse Replace(1: Replace request)
      throws (1:HibariException ouch)

  /**
   * Set
   */
  HibariResponse Set(1: Set request)
      throws (1:HibariException ouch)

  /**
   * Delete
   */
  HibariResponse Delete(1: Delete request)
      throws (1:HibariException ouch)

  /**
   * Get
   */
  HibariResponse Get(1: Get request)
      throws (1:HibariException ouch)
}</pre><p>For each primitive utility function, it has exactly one input
parameter.  The parameter is an object that has a name matching its
function. The object carries all mandatory and optional parameters to
Hibari. This object could also be used to implement micro-transactions
in the future.</p></div><div class="section" title="5.2.&#xA0;Mapping UBF Contract Types to Thrift Types"><div class="titlepage"><div><div><h3 class="title"><a id="_mapping_ubf_contract_types_to_thrift_types"></a>5.2. Mapping UBF Contract Types to Thrift Types</h3></div></div></div><p>You can find more details of the UBF / Thrift type conversion in
(<a class="ulink" href="https://github.com/norton/ubf-thrift" target="_top">UBF-Thrift</a>).</p></div><div class="section" title="5.3.&#xA0;Mapping UBF Contract to Thrift Service"><div class="titlepage"><div><div><h3 class="title"><a id="_mapping_ubf_contract_to_thrift_service"></a>5.3. Mapping UBF Contract to Thrift Service</h3></div></div></div><p>Mapping UBF types to thrift primitives is different from mapping UBF
contracts to service. Thrift mainly uses 2 different types to compose
a request (struct and field).</p><p>If you are using Thrift to generate client code, you probably don’t
need to worry about how the request being constructed. Visit
<a class="ulink" href="http://wiki.apache.org/thrift/ThriftGeneration" target="_top">Thrift Wiki</a> for
the instruction to install Thrift and to generate client code.  You
will also need <a class="ulink" href="./misc-codes/hibari.thrift" target="_top">hibari.thrift</a> to get
started.</p><p>If you are interested in the UBF contract, the Hibari NTBF contract
can be found in the file of <code class="literal">ntbf_gdss_plugin.con</code>.</p></div><div class="section" title="5.4.&#xA0;Examples of using a Thrift client"><div class="titlepage"><div><div><h3 class="title"><a id="_examples_of_using_a_thrift_client"></a>5.4. Examples of using a Thrift client</h3></div></div></div><p>Once you get the generated code, connecting to Hibari is easy.  For
example, adding the key <code class="literal">'fookey'</code> to table <code class="literal">tab1</code> with a value of
<code class="literal">'Hello, world!'</code> in the following 3 languages.</p><p>In Erlang:</p><pre class="screen">  -include("hibari_thrift.hrl").

  % init
  {ok, Client} = thrift_client:start_link("127.0.0.1", 7600, hibari_thrift),

  % create the input parameter object
  Request = #add{table=&lt;&lt;"tab1"&gt;&gt;, key=&lt;&lt;"fookey"&gt;&gt;, value=&lt;&lt;"Hello, world!"&gt;},

  % send request
  try
    HibariResponse = thrift_client:call(Client, 'Add', [Request]),
  catch
    HibariException -&gt;
      HibariException
  end,

  ok = thrift_client:close(Client).</pre><p>In Java:</p><pre class="screen">  import com.hibari.rpc.*;

  // init
  TTransport transport = new TSocket("127.0.0.1", 7600);
  TProtocol proto = new TBinaryProtocol(transport);
  Hibari.Client client = new Hibari.Client(proto);
  transport.open();

  // create the input parameter object
  Add request = new Add("tab1", ByteBuffer.wrap("fookey".getBytes()),
    ByteBuffer.wrap("Hello, world!".getBytes())))

  // send request
  try {
    HibariResponse response = client.Add(request);
  } catch (HibariException e) {
    // ...
  }

  transport.close();</pre><p>In python:</p><pre class="screen">  from hibari import Hibari

  # init
  transport = TSocket.TSocket('localhost', 7600)
  transport.setTimeout(None)
  transport = TTransport.TBufferedTransport(transport)
  protocol = TBinaryProtocol.TBinaryProtocol(transport)
  client = Hibari.Client(protocol)
  transport.open()

  # create the input parameter object
  request = Add()
  request.table = "tab1"
  request.key = b"fookey"
  request.value = b"Hello, world!"

  # send request
  response = client.Add(request)

  transport.close()</pre></div><div class="section" title="5.5.&#xA0;Mapping TBF Contract Responses From Thrift Client"><div class="titlepage"><div><div><h3 class="title"><a id="_mapping_tbf_contract_responses_from_thrift_client"></a>5.5. Mapping TBF Contract Responses From Thrift Client</h3></div></div></div><p>TBF only responses one of two generic types to all functions in Hibari
Thrift API, HibariResponse or HibariException.  One could expect a
HibariResponse in an any successful cases.  Otherwise a
HibariException should be thrown.</p></div></div><div class="section" title="6.&#xA0;Developer Utilities"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_developer_utilities"></a>6. Developer Utilities</h2></div></div></div><p><span class="emphasis"><em>Under Construction</em></span></p><div class="section" title="6.1.&#xA0;Basho Bench"><div class="titlepage"><div><div><h3 class="title"><a id="_basho_bench"></a>6.1. Basho Bench</h3></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div><div class="section" title="6.2.&#xA0;Yahoo! Cloud Serving Benchmark"><div class="titlepage"><div><div><h3 class="title"><a id="_yahoo_cloud_serving_benchmark"></a>6.2. Yahoo! Cloud Serving Benchmark</h3></div></div></div><p><span class="emphasis"><em>to be added</em></span></p></div></div><div class="section" title="7.&#xA0;Building Hibari from Source"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="HibariBuildingSource"></a>7. Building Hibari from Source</h2></div></div></div><p><span class="emphasis"><em>Under Construction</em></span></p><p>This section describes the basic recipes to build the following items:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Hibari Release Package
</li><li class="listitem">
Hibari Documentation
</li><li class="listitem">
Erlang/OTP System
</li></ul></div><p>Before getting started, review this checklist of tools and software.
Please install and setup as needed.</p><div class="variablelist"><dl><dt><span class="term">
Git (Mandatory)
</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
Git - <a class="ulink" href="http://git-scm.com/" target="_top">http://git-scm.com/</a>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<span class="strong"><strong>Git 1.5.4 or newer, Git 1.7.3.4 has been tested recently</strong></span>
</li><li class="listitem">
<span class="emphasis"><em>required for Repo and GitHub</em></span>
</li></ul></div></li><li class="listitem"><p class="simpara">
GitHub - <a class="ulink" href="https://github.com" target="_top">https://github.com</a>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
Anonymous read-only access using the GIT protocol is default.
</li><li class="listitem">
Team members having read-write access should add his/her ssh
    public key under your GitHub account.
</li></ul></div></li></ul></div></dd><dt><span class="term">
Erlang/OTP (Mandatory)
</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
OpenSSL - <a class="ulink" href="http://www.openssl.org/" target="_top">http://www.openssl.org/</a>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<span class="emphasis"><em>required for Erlang’s crypto module</em></span>
</li></ul></div></li><li class="listitem"><p class="simpara">
Erlang - <a class="ulink" href="http://www.erlang.org/" target="_top">http://www.erlang.org/</a>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<span class="strong"><strong>R13B04 or newer</strong></span>
</li><li class="listitem">
<span class="strong"><strong>R14B01 has been tested most recently</strong></span>
</li><li class="listitem">
If needed, see <a class="xref" href="#ErlangOTP" title="7.3.&#xA0;Erlang/OTP System">Section 7.3, “Erlang/OTP System”</a> for instructions to build Erlang/OTP
    from source.
</li></ul></div></li></ul></div></dd><dt><span class="term">
Python (Mandatory)
</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
Python - <a class="ulink" href="http://www.python.org" target="_top">http://www.python.org</a>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<span class="strong"><strong>Python 2.4 or newer, Python 2.7 has been tested most recently
     (CAUTION: Python 3.x might be too new)</strong></span>
</li><li class="listitem">
<span class="emphasis"><em>required for Repo and AsciiDoc</em></span>
</li></ul></div></li></ul></div></dd><dt><span class="term">
AsciiDoc (Optional)
</span></dt><dd><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem"><p class="simpara">
AsciiDoc - <a class="ulink" href="http://www.methods.co.nz/asciidoc/index.html" target="_top">http://www.methods.co.nz/asciidoc/index.html</a>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
<span class="strong"><strong>asciidoc 8.6.1 and asciidoc 9.6.3 have been tested most recently</strong></span>
</li><li class="listitem"><p class="simpara">
plus the following tools:
</p><div class="itemizedlist"><ul class="itemizedlist" type="square"><li class="listitem">
ImageMagick - <a class="ulink" href="http://www.imagemagick.org/" target="_top">http://www.imagemagick.org/</a>
</li><li class="listitem">
graphviz - <a class="ulink" href="http://www.graphviz.org/" target="_top">http://www.graphviz.org/</a>
</li><li class="listitem">
mscgen - <a class="ulink" href="http://www.mcternan.me.uk/mscgen/" target="_top">http://www.mcternan.me.uk/mscgen/</a>
</li></ul></div></li><li class="listitem">
Mandatory for building Hibari’s documentation. See
    <a class="xref" href="#HibariAsciiDoc" title="7.2.&#xA0;Hibari Documentation">Section 7.2, “Hibari Documentation”</a> for further details.
</li></ul></div></li><li class="listitem"><p class="simpara">
docbook - <a class="ulink" href="http://www.docbook.org/" target="_top">http://www.docbook.org/</a>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
Optional for building <span class="emphasis"><em>pdf</em></span> version of Hibari’s documentation
</li></ul></div></li><li class="listitem"><p class="simpara">
xmlto - <a class="ulink" href="https://fedorahosted.org/xmlto/" target="_top">https://fedorahosted.org/xmlto/</a>
</p><div class="itemizedlist"><ul class="itemizedlist" type="circle"><li class="listitem">
Optional for building <span class="emphasis"><em>text</em></span> version of Hibari’s documentation
</li></ul></div></li></ul></div></dd></dl></div><p>In addition to the above list, Hibari also depends on two tools to
automate the downloading and the packaging steps.</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
Repo - <a class="ulink" href="http://source.android.com/source/git-repo.html" target="_top">http://source.android.com/source/git-repo.html</a>
</li><li class="listitem">
Rebar - <a class="ulink" href="https://github.com/basho/rebar/wiki" target="_top">https://github.com/basho/rebar/wiki</a>
</li></ul></div><p>Instructions for downloading the Repo tool are described next.  The
Rebar tool is included in Hibari’s git repositories so there is no
need to download it separately.  Please refer to the above sites for
further information regarding the usage of these tools.</p><p>The first step is to download the Git repositories from GitHub.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Downloading <span class="emphasis"><em>basic recipe</em></span>
</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p class="simpara">
Configure your e-mail and name for Git
</p><pre class="screen">$ git config --global user.email "you@example.com"
$ git config --global user.name "Your Name"</pre></li><li class="listitem"><p class="simpara">
Install Repo
</p><pre class="screen">$ mkdir -p ~/bin
$ wget -O - http://android.git.kernel.org/repo &gt; ~/bin/repo
$ chmod a+x ~/bin/repo</pre></li><li class="listitem"><p class="simpara">
Create working directory
</p><pre class="screen">$ mkdir working-directory-name
$ cd working-directory-name
$ repo init -u git://github.com/hibari/manifests.git -m hibari-default.xml</pre><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Your "Git" identity is needed during the init step.  Please
enter the name and email of your GitHub account if you have one.  Team
members having read-write access are recommended to use "repo init -u
<a class="ulink" href="mailto:git@github.com" target="_top">git@github.com</a>:hibari/manifests.git -m hibari-default-rw.xml".</p></td></tr></table></div></li><li class="listitem"><p class="simpara">
Download Git repositories
</p><pre class="screen">$ cd working-directory-name
$ repo sync</pre><p class="simpara">The working directory has the following layout structure:</p></li></ol></div></li></ol></div><pre class="screen">&lt;working-directory-name&gt;
  |- hibari/
    |- .git/
    |- .gitignore
    |- Makefile
    |- dialyze-ignore-warnings.txt
    |- dialyze-nospec-ignore-warnings.txt
    |- lib/                             <a id="CO1-1"></a><img src="images/icons/callouts/1.png" alt="1" border="0" />
      |- &lt;application_name&gt;/
        |- .git/
        |- .gitignore
        |- ebin/
        |- include/
          |- *.hrl
        |- priv/
        |- rebar.config
        |- src/
          |- &lt;application_name&gt;.app.src
          |- *.erl
        |- test/
          |- eunit/
            |- *.erl
          |- eqc/
            |- *.erl
      :
    |- rebar
    |- rebar.config
    |- rel/                             <a id="CO1-2"></a><img src="images/icons/callouts/2.png" alt="2" border="0" />
      |- files/
        |- app.config
        |- erl
        |- hibari
        |- hibari-admin
        |- nodetool
        |- nodetool-admin
        |- vm.args
      |- hibari/
        :
        |- releases/
          |- &lt;release_vsn&gt;/
            :
          :
        :
      |- reltool.config
  |- hibari-doc/                        <a id="CO1-3"></a><img src="images/icons/callouts/3.png" alt="3" border="0" />
    :
  |- manifests/                         <a id="CO1-4"></a><img src="images/icons/callouts/4.png" alt="4" border="0" />
    :
  |- patches/                           <a id="CO1-5"></a><img src="images/icons/callouts/5.png" alt="5" border="0" />
    :
  |- rebar/                             <a id="CO1-6"></a><img src="images/icons/callouts/6.png" alt="6" border="0" />
    :
  |- .repo/
    :</pre><div class="calloutlist"><table border="0" summary="Callout list"><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-1"><img src="images/icons/callouts/1.png" alt="1" border="0" /></a> </p></td><td valign="top" align="left"><p>
Applications
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-2"><img src="images/icons/callouts/2.png" alt="2" border="0" /></a> </p></td><td valign="top" align="left"><p>
Releases
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-3"><img src="images/icons/callouts/3.png" alt="3" border="0" /></a> </p></td><td valign="top" align="left"><p>
Documentation
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-4"><img src="images/icons/callouts/4.png" alt="4" border="0" /></a> </p></td><td valign="top" align="left"><p>
Manifests
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-5"><img src="images/icons/callouts/5.png" alt="5" border="0" /></a> </p></td><td valign="top" align="left"><p>
Patches
</p></td></tr><tr><td width="5%" valign="top" align="left"><p><a href="#CO1-6"><img src="images/icons/callouts/6.png" alt="6" border="0" /></a> </p></td><td valign="top" align="left"><p>
Rebar
</p></td></tr></table></div><div class="section" title="7.1.&#xA0;Hibari Release Package"><div class="titlepage"><div><div><h3 class="title"><a id="_hibari_release_package"></a>7.1. Hibari Release Package</h3></div></div></div><p>This section is the first step to build, to <span class="emphasis"><em>eunit</em></span> test, and to
package your own Hibari.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Building <span class="emphasis"><em>basic recipe</em></span>
</p><pre class="screen">$ cd working-directory-name/hibari
$ make</pre><div class="tip" title="Tip" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/icons/tip.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>If the response is "make: erl: Command not found", please make
sure Erlang/OTP is installed and "otp-installing-directory-name/bin"
is added to your $PATH environment.</p></td></tr></table></div></li><li class="listitem"><p class="simpara">
Release Packaging <span class="emphasis"><em>basic recipe</em></span>
</p><pre class="screen">$ cd working-directory-name/hibari
$ make package</pre><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>A release package tarball "hibari-X.Y.Z-dev-ARCH-WORDSIZE.tgz"
and md5sum file "hibari-X.Y.Z-dev-ARCH-WORDSIZE-md5sum.txt" is written
to working-directory-name.</p></td></tr></table></div></li></ol></div></div><div class="section" title="7.2.&#xA0;Hibari Documentation"><div class="titlepage"><div><div><h3 class="title"><a id="HibariAsciiDoc"></a>7.2. Hibari Documentation</h3></div></div></div><p>This section is the first step to download and to build your own
Hibari documentation.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Building Hibari’s "Guides" <span class="emphasis"><em>basic recipe</em></span>
</p><pre class="screen">$ cd working-directory-name/hibari-doc/src/hibari
$ make clean -OR- make realclean
$ make</pre></li><li class="listitem"><p class="simpara">
Building Hibari’s "Website" <span class="emphasis"><em>basic recipe</em></span>
</p><pre class="screen">$ cd working-directory-name/hibari-doc/src/hibari/website
$ make clean -OR- make realclean
$ make</pre><div class="note" title="Note" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/icons/note.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>HTML documentation is written in the "./public_html" directory.</p></td></tr></table></div></li></ol></div><p>Hibari’s documentation is authored using AsciiDoc and a few auxillary
tools:</p><div class="itemizedlist"><ul class="itemizedlist" type="disc"><li class="listitem">
ImageMagick
</li><li class="listitem">
docbook
</li><li class="listitem">
graphviz
</li><li class="listitem">
mscgen
</li><li class="listitem">
xmlto
</li></ul></div><p>Hibari’s documentation is generated with asciidoc 8.6.3 and a manually
modified version of the a2x tool.</p><pre class="screen">$ diff -u /usr/local/Cellar/asciidoc/8.6.3/bin/a2x{.orig,}
--- /usr/local/Cellar/asciidoc/8.6.3/bin/a2x.orig       2011-01-02 18:09:35.000000000 +0900
+++ /usr/local/Cellar/asciidoc/8.6.3/bin/a2x    2011-01-02 18:11:19.000000000 +0900
@@ -156,7 +156,10 @@
 def shell_copy(src, dst):
     verbose('copying "%s" to "%s"' % (src,dst))
     if not OPTIONS.dry_run:
-        shutil.copy(src, dst)
+        try:
+            shutil.copy(src, dst)
+        except shutil.Error:
+            return

 def shell_rm(path):
     if not os.path.exists(path):</pre></div><div class="section" title="7.3.&#xA0;Erlang/OTP System"><div class="titlepage"><div><div><h3 class="title"><a id="ErlangOTP"></a>7.3. Erlang/OTP System</h3></div></div></div><p>This section is the first step to download, to build, and to install
your own Erlang/OTP system.</p><div class="orderedlist"><ol class="orderedlist" type="1"><li class="listitem"><p class="simpara">
Downloading <span class="emphasis"><em>basic recipe</em></span>
</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem">
Please make sure to have the <span class="emphasis"><em>openssl-devel</em></span> package installed on
     your system.  OpenSSL is required by Hibari (and before
     configuring and building of your Erlang/OTP system).
</li><li class="listitem">
Get and install Git
</li><li class="listitem"><p class="simpara">
Download the source code for your Erlang/OTP system
</p><pre class="screen">$ cd working-directory-name
$ wget http://www.erlang.org/download/otp_src_R14B01.tar.gz</pre></li><li class="listitem"><p class="simpara">
Untar the source code for your Erlang/OTP system.
</p><pre class="screen">$ cd working-directory-name
$ tar -xzf otp_src_R14B01.tar.gz</pre></li></ol></div></li><li class="listitem"><p class="simpara">
Building <span class="emphasis"><em>basic recipe</em></span>
</p><div class="orderedlist"><ol class="orderedlist" type="a"><li class="listitem"><p class="simpara">
Change to your working directory and configure Erlang/OTP
</p><pre class="screen">$ cd working-directory-name/otp_src_R14B01
$ ./configure --prefix=otp-installing-directory-name</pre></li><li class="listitem"><p class="simpara">
Build Erlang/OTP
</p><pre class="screen">$ cd working-directory-name/otp_src_R14B01
$ make</pre></li></ol></div></li><li class="listitem"><p class="simpara">
Installing <span class="emphasis"><em>basic recipe</em></span>
</p><pre class="screen">$ cd working-directory-name/otp_src_R14B01
$ sudo make install</pre></li></ol></div><div class="caution" title="Caution" style="margin-left: 0; margin-right: 10%;"><table border="0" summary="Caution"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="images/icons/caution.png" /></td><th align="left"></th></tr><tr><td align="left" valign="top"><p>Please make sure "otp-installing-directory-name/bin" is added
to your $PATH environment.</p></td></tr></table></div></div></div><div class="section" title="8.&#xA0;Sample Application"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_sample_application"></a>8. Sample Application</h2></div></div></div><p><span class="emphasis"><em>Under Construction</em></span></p></div></div></body></html>
